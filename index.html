<!DOCTYPE html>

<html>
<head>

<script>
    function loadGoogleMaps() {
      const script = document.createElement('script');
      script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyDTvDRPKBT7KDONeDgekEXlN1_CMZUtX4U&libraries=places,geometry&callback=initMap&loading=async';
      script.async = true;
      script.defer = true;
      script.onerror = function() {
        showError('Kon Google Maps API niet laden. Controleer je internetverbinding.');
      };
      document.head.appendChild(script);
    }
    window.onload = loadGoogleMaps;


async function suggestBrianAssignments() {
  const brianAfspraken = afsprakenData
    .filter(a => a.operators.map(o => o.toLowerCase()).includes('brian'))
    .sort((a, b) => {
      const dateA = parseDatumEnTijd(a.datum, a.tijd);
      const dateB = parseDatumEnTijd(b.datum, b.tijd);
      return dateA - dateB;
    });

  if (brianAfspraken.length === 0) {
    alert('Geen Brian-afspraken gevonden.');
    return;
  }

  const suggestions = brianAfspraken
    .map(a => `${a.datum} ${a.tijd} - ${a.adres ?? ''}`.trim())
    .join("\n");

  alert("Brian suggesties:\n" + suggestions);
}
}


  

</script>

<title>Afsprakenkaart - Premium Edition</title>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<!-- Verbeterde Google Maps API loading -->

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
<style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
      color: #eee;
      overflow-x: hidden;
    }

    #topbar {
      display: flex;
      align-items: center;
      background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
      padding: 15px 25px;
      justify-content: space-between;
      color: white;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    #topbar::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    #title {
      font-weight: 800;
      font-size: 1.8rem;
      letter-spacing: 2px;
      user-select: none;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      background: linear-gradient(45deg, #FFD700, #FFA500, #FF6B6B);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    #logo {
      height: 45px;
      user-select: none;
      margin: 0 auto;
      display: block;
      transition: transform 0.3s ease;
    }

    #logo:hover {
      transform: scale(1.1) rotate(5deg);
    }

    #counter {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      font-size: 0.95rem;
      color: #aaa;
      gap: 5px;
    }

    #counter .count-today {
      font-weight: bold;
      color: #4CAF50;
      text-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
    }

    #counter .count-total {
      color: #FFC107;
      text-shadow: 0 0 10px rgba(255, 193, 7, 0.3);
    }

    #searchInput {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.2);
      padding: 10px 15px;
      border-radius: 25px;
      font-size: 1rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      min-width: 200px;
    }

    #searchInput:focus {
      outline: none;
      border-color: #FFD700;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
      transform: scale(1.05);
    }

    #searchInput::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    #controls {
      padding: 15px 25px;
      background: linear-gradient(135deg, #1e1e2e 0%, #2d2d3a 100%);
      display: flex;
      gap: 1.5rem;
      align-items: center;
      flex-wrap: wrap;
      color: white;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
    }

    select, input[type="text"] {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.2);
      padding: 8px 15px;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    select option {
      background: #2d2d3a;
      color: white;
    }

    select:focus, select:hover {
      border-color: #FFD700;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
      transform: translateY(-2px);
    }

    label {
      user-select: none;
      font-weight: 600;
      color: #FFD700;
    }

    #map {
      height: 75vh;
      width: 100%;
      border-radius: 0;
      position: relative;
      overflow: hidden;
    }

    /* Styles for Google Maps InfoWindow (popup) */
    .gm-style-iw.gm-style-iw-c { /* Outer wrapper for InfoWindow */
        padding: 0; /* Remove default padding */
    }

    .gm-style-iw-d { /* Inner scrollable div */
        overflow: hidden !important; /* Prevent scrollbars if content fits */
        padding: 0; /* Remove default padding */
    }

    .gm-ui-hover-effect { /* Close button background */
        background: rgba(255, 215, 0, 0.2) !important;
        border-radius: 50%;
    }

    .gm-ui-hover-effect span { /* Close button X icon */
        color: #FFD700 !important;
    }

    .gm-style-iw {
        /* These styles affect the InfoWindow's overall container/border/background */
        background: linear-gradient(135deg, #1e1e2e 0%, #2d2d3a 100%) !important;
        color: white !important; /* Default text color for the InfoWindow container */
        border-radius: 10px !important;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
        border: none !important; /* Remove default border */
        padding: 10px !important; /* Adjusted padding to let internal content control spacing */
    }

    /* Arrow of the InfoWindow */
    .gm-style-iw::after {
      background: linear-gradient(135deg, #1e1e2e 0%, #2d2d3a 100%) !important;
    }

    /* Legend */
    #legend {
      padding: 15px 25px;
      background: linear-gradient(135deg, #1e1e2e 0%, #2d2d3a 100%);
      color: white;
      font-size: 0.95rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: center;
      box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.2);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 8px 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      cursor: pointer;
    }

    .legend-item:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .legend-item.active {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid #FFD700;
    }

    .legend-icon {
      font-size: 1.4rem;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    }

    #travel-info {
      padding: 20px 25px;
      background: linear-gradient(135deg, #2d2d3a 0%, #3d3d4a 100%);
      border-top: 3px solid #FFD700;
      font-size: 0.95rem;
      color: #FFD700;
      display: none;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .travel-segment {
      margin: 12px 0;
      padding: 15px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 10px;
      border-left: 4px solid #FFD700;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .travel-segment:hover {
      background: rgba(255, 215, 0, 0.2);
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #clear-selection {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
    }

    #clear-selection:hover {
      background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
    }

    #clear-selection:active {
      transform: translateY(0);
    }

#advice-brian-btn {
  background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
}
#advice-brian-btn:hover {
  background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
}
#advice-brian-btn:active {
  transform: translateY(0);
}


    /* Loading animation */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10000;
      color: #FFD700;
      font-size: 1.2rem;
      display: none;
    }

    .spinner {
      border: 4px solid rgba(255, 215, 0, 0.1);
      border-top: 4px solid #FFD700;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
      #topbar {
        flex-direction: column;
        gap: 10px;
        padding: 10px 15px;
      }

      #title {
        font-size: 1.4rem;
      }

      #controls {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      select, input[type="text"] {
        width: 100%;
      }

      #map {
        height: 60vh;
      }

      .legend-item {
        flex: 1;
        justify-content: center;
      }
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #888;
      font-size: 1.1rem;
    }

    .error-message {
      background: rgba(244, 67, 54, 0.1);
      border: 2px solid #f44336;
      padding: 15px;
      border-radius: 10px;
      margin: 20px;
      color: #f44336;
      text-align: center;
    }

    /* Traffic layer toggle */
    .traffic-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(30, 30, 46, 0.9);
      padding: 8px;
      border-radius: 4px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      color: white;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .traffic-toggle:hover {
      background: rgba(45, 45, 58, 0.9);
    }

    .traffic-toggle.active {
      color: #4CAF50;
    }

    /* Time indicator for live traffic */
    .live-time-indicator {
      background: rgba(30, 30, 46, 0.9);
      padding: 5px 10px;
      border-radius: 4px;
      color: #4CAF50;
      font-size: 0.8rem;
      margin-left: 5px;
      display: inline-flex;
      align-items: center;
    }

    /* Dragging feedback styles */
    .dragging-marker {
      z-index: 1000 !important;
      opacity: 0.8 !important;
      transform: scale(1.2);
      transition: transform 0.2s, opacity 0.2s;
    }

    .drop-target-marker {
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
  

#conflictLog h3 {
  margin-top: 0;
  font-size: 16px;
}
.conflict-entry {
  margin-bottom: 8px;
  border-bottom: 1px solid #ccc;
  padding-bottom: 5px;
}

#toolbar input, #toolbar select {
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

#conflictLog {
  position: fixed;
  top: 80px;
  right: 10px;
  width: 300px;
  max-height: 80vh;
  overflow-y: auto;
  background: white;
  border: 1px solid #ccc;
  padding: 10px;
  z-index: 9999;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
.conflict-entry {
  margin-bottom: 8px;
  border-bottom: 1px solid #ccc;
  padding-bottom: 5px;
}

#conflictContainer {
  margin-top: 10px;
  background: #fff3f3;
  border: 1px solid #e0b4b4;
  padding: 10px;
  font-size: 14px;
}
.conflict-entry {
  margin-bottom: 6px;
  border-bottom: 1px dashed #ccc;
  padding-bottom: 4px;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>





</script></head>
<body>
<div class="loading" id="loading">
<div class="spinner"></div>
<div>Laden van afspraken...</div>
</div>
<div id="topbar">
<div id="title"><i class="fas fa-map-marked-alt"></i> Afsprakenkaart</div>
<img alt="Voltsmart Logo" draggable="false" id="logo" src="https://cdn.prod.website-files.com/68503ddc6fb75a92cad47e2a/68515d53bc9b66440249398b_Logo%20(1).svg"/>
<div id="counter">
<div class="count-today"><i class="fas fa-calendar-day"></i> Vandaag: <span id="count-today">0</span></div>
<div class="count-total"><i class="fas fa-chart-bar"></i> Totaal: <span id="count-total">0</span></div>
</div>
<input id="searchInput" placeholder="üîç Zoek adres of postcode" type="text"/>
</div>
<div id="controls">
<label for="datumSelect"><i class="fas fa-calendar"></i> Datum:</label>
<select id="datumSelect">
<option value="">-- Alles --</option>
</select>
<label for="operatorSelect"><i class="fas fa-user"></i> Operator:</label>
<select id="operatorSelect">
<option value="">-- Iedereen --</option>
</select>
<label>
<input checked="" id="showPastAppointments" type="checkbox"/> Toon verleden afspraken
    </label>
<button id="clear-selection"><i class="fas fa-trash"></i> Wis selectie</button><button id="advice-brian-btn" onclick="suggestBrianAssignments()">Adviseer Brian</button>
</div>
<div id="toolbar" style="padding:10px; background:#f3f3f3; display:flex; gap:10px; align-items:center;">
<input id="zoekInput" placeholder="Zoek klant of adres..." style="flex:1; padding:6px;" type="text"/>
<select id="dagFilter" style="padding:6px;">
<option value="">Alle dagen</option>
</select>
<button onclick="wisSelectie()">Wis selectie</button>

</div><div id="map"></div>
<div id="travel-info">
<strong><i class="fas fa-route"></i> Reistijd tussen geselecteerde afspraken:</strong>
<div id="travel-details"></div>
</div>
<div id="legend"></div><script>
    // ZORG DAT DEZE URL CORRECT IS EN GEEN SPATIES BEVAT!
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQu2tdR_UHXSEhvRq0Sga15iSOq9A6dDFfGrgLmtQ5k4oJW1NsBNb604HSecpGI9gqY5AWXjTvzArJQ/pub?output=csv"; 
    const googleAPIKey = "AIzaSyDTvDRPKBT7KDONeDgekEXlN1_CMZUtX4U";

    // VERVANG DIT MET DE NIEUWE URL VAN JE GOOGLE APPS SCRIPT WEB-APP!
    const googleAppsScriptURL = "https://script.google.com/a/macros/voltsmart.nl/s/AKfycbyJ6yzz6q3_090kLfTPTPMIxuZ1BZPBiXH20DIXmcwWE5tcVFR7ceg4zM4JwMkVBjzOYA/exec"; 

    const operatorEmoji = {
      Roelof: "üë®üåæ",
      Jesse: "üöÄ",
      Chanice: "‚ú®",
      Karlijn: "üå∏",
      Keith: "üü°",
      Gio: "üëë",
      Hans: "üë®üíº",
      brian: "üë®üîß"
    };

    let map;
    let allMarkers = [];
    let afsprakenData = [];
    let selectedMarkers = [];
    let selectedAfspraken = [];
    let directionsService;
    let directionsRenderer;
    let trafficLayer;
    let liveTrafficEnabled = false;
    let searchResults = [];
    let activeLegendFilter = null;
    let geocoder;
    let currentlyDragging = null;
    let routePolyline;

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function isAfspraakInPast(afspraak) {
      const now = new Date();
      try {
        const afspraakDate = parseDatumEnTijd(afspraak.datum, afspraak.tijd);
        return afspraakDate < now;
      } catch (e) {
        console.error('Fout bij parsen datum/tijd:', e, afspraak.datum, afspraak.tijd);
        return false;
      }
    }

    function parseDatumEnTijd(datumStr, tijdStr) {
      // Verbeterde datum parser voor verschillende formaten
      if (!datumStr || !tijdStr) {
        throw new Error('Datum of tijd ontbreekt');
      }
      
      // Probeer verschillende datumformaten
      let dateParts;
      if (datumStr.includes('/')) {
        dateParts = datumStr.split('/');
      } else if (datumStr.includes('-')) {
        dateParts = datumStr.split('-');
      } else {
        throw new Error('Ongeldig datumformaat');
      }
      
      if (dateParts.length !== 3) {
        throw new Error('Ongeldig datumformaat');
      }
      
      // Parse jaar (ondersteunt 2-cijferige jaren)
      let jaar = parseInt(dateParts[2]);
      if (jaar < 100) {
        jaar += 2000; // Aanname voor 21e eeuw
      }

      const dag = parseInt(dateParts[0]);
      const maand = parseInt(dateParts[1]) - 1; // Maanden zijn 0-based
      
      // Tijd parsing
      let uren = 0, minuten = 0;
      if (tijdStr.includes(':')) {
        const tijdParts = tijdStr.split(':');
        uren = parseInt(tijdParts[0]) || 0;
        minuten = parseInt(tijdParts[1]) || 0;
      } else {
        uren = parseInt(tijdStr) || 0;
      }
      
      const parsedDate = new Date(jaar, maand, dag, uren, minuten);
      
      // Validatie
      if (isNaN(parsedDate.getTime())) {
        throw new Error('Ongeldige datum/tijd combinatie');
      }
      
      return parsedDate;
    }

    window.initMap = async function () {
        showLoading(true);

        try {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 52.1, lng: 5.1 },
                zoom: 7,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                zoomControl: true,
                streetViewControl: false,
                fullscreenControl: false,
                mapTypeControl: false
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                polylineOptions: {
                    strokeColor: '#007bff',
                    strokeOpacity: 0.8,
                    strokeWeight: 4,
                    icons: [{
                        icon: {
                            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                            scale: 4,
                            strokeColor: '#007bff'
                        },
                        offset: '100%'
                    }]
                },
                suppressMarkers: true
            });
            geocoder = new google.maps.Geocoder();

            const trafficToggleDiv = document.createElement('div');
            trafficToggleDiv.className = 'traffic-toggle';
            trafficToggleDiv.innerHTML = '<i class="fas fa-traffic-light"></i> Verkeer';
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(trafficToggleDiv);
            trafficToggleDiv.onclick = toggleTrafficLayer;

            await loadAfspraken();
            buildFilters();
            buildLegend();
            
            // Standaard openen op afspraken van vandaag
            const todayString = getTodayString();
            const datumSelect = document.getElementById("datumSelect");
            const todayOptionExists = Array.from(datumSelect.options).some(option => option.value === todayString);
            if (todayOptionExists) {
                datumSelect.value = todayString;
            } else {
                datumSelect.value = ""; // Default naar "-- Alles --"
            }
            
            updateMarkers();
            updateCounter();

            document.getElementById("clear-selection").addEventListener("click", clearSelection);

            document.getElementById("searchInput").addEventListener("input",
                debounce(handleSearch, 300)
            );

            document.getElementById("showPastAppointments").addEventListener("change", () => {
                updateMarkers();
                updateCounter();
            });

            showLoading(false);
        } catch (error) {
            console.error('Initialisatie fout:', error);
            showError('Er is een fout opgetreden bij het laden van de applicatie. Controleer Google API key.');
            showLoading(false);
        }
    };

    function toggleTrafficLayer() {
      if (!trafficLayer) {
        trafficLayer = new google.maps.TrafficLayer();
      }

      if (liveTrafficEnabled) {
        trafficLayer.setMap(null);
        liveTrafficEnabled = false;
        document.querySelector('.traffic-toggle').classList.remove('active');
      } else {
        trafficLayer.setMap(map);
        liveTrafficEnabled = true;
        document.querySelector('.traffic-toggle').classList.add('active');

        if (map.getZoom() < 10) {
            map.setZoom(10);
        }

        if (selectedAfspraken.length >= 2) {
            updateTravelInfo();
        }
      }
    }

    function showLoading(show) {
      document.getElementById("loading").style.display = show ? "block" : "none";
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
      document.body.appendChild(errorDiv);

      setTimeout(() => {
        if (document.body.contains(errorDiv)) {
          document.body.removeChild(errorDiv);
        }
      }, 5000);
    }

    async function loadAfspraken() {
      showLoading(true);
      try {
        const res = await fetch(sheetURL);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status} voor URL: ${sheetURL}`);

        const csvText = await res.text();
        const rows = csvText.split("\n").slice(1); // sla header over
        afsprakenData = [];
        let errorCount = 0;

        for (const row of rows) {
          if (!row.trim()) continue;

          try {
            // Basis CSV parsing - voor complexere CSV zou je een library moeten gebruiken
            const cols = row.split(',').map(col => col.trim());
            
            // Controleer of er voldoende kolommen zijn
            if (cols.length < 9) {
              console.warn("Rij heeft te weinig kolommen:", row);
              errorCount++;
              continue;
            }

        const datum = cols[0];
const medewerker = cols[1];
const klantnaam = cols[2];
const adres = cols[3];
const status = cols[4] || "Gepland";
const tijd = cols[5];
const lat = parseFloat((cols[8] || "").replace(",", "."));
const lon = parseFloat((cols[9] || "").replace(",", "."));

// Validatie
if (!datum || !medewerker || !klantnaam || !adres || !tijd || isNaN(lat) || isNaN(lon)) {
  console.warn("Ontbrekende of ongeldige data in rij:", cols);
  errorCount++;
  continue;
}

            // Probeer datum te parsen voor validatie
            try {
              parseDatumEnTijd(datum, tijd);
            } catch (e) {
              console.warn("Ongeldige datum/tijd in rij:", datum, tijd, "Fout:", e.message);
              errorCount++;
              continue;
            }

            const operators = medewerker.split(/[;,]/).map((o) => o.trim()).filter(o => o);

            afsprakenData.push({
              datum,
              tijd,
              operators,
              adres,
              status,
              lat,
              lon,
              originalDatum: datum, 
              originalTijd: tijd,
              originalAdres: adres
            });
          } catch (e) {
            console.error("Fout bij verwerken rij:", row, "Fout:", e);
            errorCount++;
          }
        }

        if (errorCount > 0) {
          showError(`‚ö†Ô∏è ${errorCount} rijen konden niet worden verwerkt. Controleer de gegevens.`);
        }

        if (afsprakenData.length === 0) {
          showError("‚ö†Ô∏è Geen geldige afspraken gevonden. Controleer je Google Sheet structuur.");
        }
      } catch (error) {
        console.error("Fout bij laden van afspraken:", error);
        showError("Fout bij laden van afspraken. Controleer je spreadsheet URL of API-verbinding.");
      } finally {
        showLoading(false);
      }
    }

    function getTodayString() {
      const today = new Date();
      const day = today.getDate().toString().padStart(2, '0');
      const month = (today.getMonth() + 1).toString().padStart(2, '0');
      const year = today.getFullYear();
      return `${day}-${month}-${year}`; 
    }

    function updateCounter() {
      const selectedDatum = document.getElementById("datumSelect").value;
      const selectedOperator = document.getElementById("operatorSelect").value;
      const showPast = document.getElementById("showPastAppointments").checked;

      // Filter voor de "Totaal" teller
      const filteredForDisplay = afsprakenData.filter((a) => {
        const datumMatch = !selectedDatum || a.datum === selectedDatum;
        const operatorMatch = !selectedOperator || a.operators.includes(selectedOperator);
        const pastMatch = showPast || !isAfspraakInPast(a);
        return datumMatch && operatorMatch && pastMatch;
      });

      // 'Vandaag' telling baseren op de werkelijke huidige dag
      const todayString = getTodayString();
      const actualTodayCount = afsprakenData.filter(a => 
        a.datum === todayString && (showPast || !isAfspraakInPast(a))
      ).length;

      const totalCount = filteredForDisplay.length;

      animateCounter("count-today", actualTodayCount);
      animateCounter("count-total", totalCount);
    }

    function animateCounter(elementId, targetValue) {
      const element = document.getElementById(elementId);
      const currentValue = parseInt(element.textContent) || 0;
      const increment = targetValue > currentValue ? 1 : -1;
      const duration = 500;
      const steps = Math.abs(targetValue - currentValue);

      if (steps === 0) {
        element.textContent = targetValue;
        return;
      }

      const stepTime = duration / steps;
      let current = currentValue;

      const timer = setInterval(() => {
        current += increment;
        element.textContent = current;
        if (current === targetValue) {
          clearInterval(timer);
        }
      }, stepTime);
    }

    function buildFilters() {
      const datumSelect = document.getElementById("datumSelect");
      const operatorSelect = document.getElementById("operatorSelect");

      const uniekeDatums = [...new Set(afsprakenData.map((a) => a.datum))];

      uniekeDatums.sort((a, b) => {
        try {
          const dateA = parseDatumEnTijd(a, "00:00");
          const dateB = parseDatumEnTijd(b, "00:00");
          return dateA.getTime() - dateB.getTime();
        } catch (e) {
          console.error('Fout bij sorteren datums:', e);
          return 0;
        }
      });

      datumSelect.innerHTML = '<option value="">-- Alles --</option>';
      uniekeDatums.forEach((d) => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        datumSelect.appendChild(opt);
      });

      const allOps = afsprakenData.flatMap((a) => a.operators);
      const uniekeOperators = [...new Set(allOps)].sort();

      operatorSelect.innerHTML = '<option value="">-- Iedereen --</option>';
      uniekeOperators.forEach((o) => {
        const opt = document.createElement("option");
        opt.value = o;
        opt.textContent = o;
        operatorSelect.appendChild(opt);
      });

      const updateFunction = debounce(() => {
        updateMarkers();
        updateCounter();
      }, 200);

      datumSelect.addEventListener("change", updateFunction);
      operatorSelect.addEventListener("change", updateFunction);
    }

    function buildLegend() {
      const legend = document.getElementById("legend");
      legend.innerHTML = "<strong><i class='fas fa-info-circle'></i> Legenda:</strong>";

      for (const [naam, emoji] of Object.entries(operatorEmoji)) {
        const item = document.createElement("div");
        item.className = "legend-item";
        item.innerHTML = `<span class="legend-icon">${emoji}</span> ${naam}`;
        item.dataset.operator = naam;

        item.addEventListener("click", () => {
          if (activeLegendFilter === naam) {
            item.classList.remove("active");
            activeLegendFilter = null;
          } else {
            document.querySelectorAll(".legend-item").forEach(el => el.classList.remove("active"));
            item.classList.add("active");
            activeLegendFilter = naam;
          }

          updateMarkers();
        });

        legend.appendChild(item);
      }

      const selectedItem = document.createElement("div");
      selectedItem.className = "legend-item";
      selectedItem.innerHTML = `<span class="legend-icon" style="color: #FFD700;"><i class="fas fa-route"></i></span> Route geselecteerd`;
      legend.appendChild(selectedItem);
    }

    function getMarkerIcon(emoji, isSelected, isPast) {
        let size = 28;
        let emojiColor = 'white';
        let textShadow = '0 2px 8px rgba(0, 0, 0, 0.5)';
        let circleSvg = '';
        let pulseAnimation = '';
        let markerOpacity = 1;

        if (isPast) {
            emojiColor = 'rgba(255, 255, 255, 0.5)';
            markerOpacity = 0.6;
        }

        if (isSelected) {
            size = 36;
            emojiColor = '#FFD700';
            if (isPast) emojiColor = 'rgba(255, 215, 0, 0.5)';
            textShadow = '0 0 15px rgba(255, 215, 0, 0.8), 0 0 30px rgba(255, 215, 0, 0.5)';
            circleSvg = `
                <circle cx="${(size+10)/2}" cy="${(size+10)/2}" r="${size/2 + 5}" fill="url(#grad)" stroke="#FFD700" stroke-width="2" style="filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));"/>
            `;
            pulseAnimation = `
                <style>
                    @keyframes svg-pulse {
                        0% { transform: scale(1); opacity: 1; }
                        70% { transform: scale(1.1); opacity: 0.7; }
                        100% { transform: scale(1); opacity: 1; }
                    }
                    circle {
                        animation: svg-pulse 2s infinite;
                        transform-origin: center center;
                    }
                </style>
            `;
        }

        const svgContent = `
            <svg width="${size + 10}" height="${size + 10}" viewBox="0 0 ${size + 10} ${size + 10}" fill="none" xmlns="http://www.w3.org/2000/svg">
                ${pulseAnimation}
                ${circleSvg}
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="${size}px" font-family="Segoe UI Emoji, Apple Color Emoji, Segoe UI Symbol, Noto Color Emoji" fill="${emojiColor}" style="text-shadow: ${textShadow}; user-select: none;">
                    ${emoji}
                </text>
                <defs>
                    <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="rgba(22, 33, 62, 0.8)" />
                        <stop offset="100%" stop-color="rgba(15, 52, 96, 0.8)" />
                    </linearGradient>
                </defs>
            </svg>
        `;

        return {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svgContent),
            scaledSize: new google.maps.Size(size + 10, size + 10),
            anchor: new google.maps.Point((size + 10) / 2, (size + 10) / 2),
            opacity: markerOpacity
        };
    }

    function updateMarkers() {
      const selectedLatLons = selectedMarkers.map(marker => ({
        lat: marker.getPosition().lat(),
        lng: marker.getPosition().lng()
      }));

      allMarkers.forEach(marker => marker.setMap(null));
      allMarkers = [];
      selectedMarkers = [];

      searchResults.forEach(marker => marker.setMap(null));
      searchResults = [];

      const selectedDatum = document.getElementById("datumSelect").value;
      const selectedOperator = document.getElementById("operatorSelect").value;
      const showPast = document.getElementById("showPastAppointments").checked;

      const filteredData = afsprakenData.filter((a) => {
        const datumMatch = !selectedDatum || a.datum === selectedDatum;
        const operatorMatch = !selectedOperator || a.operators.includes(selectedOperator);
        const legendMatch = !activeLegendFilter || a.operators.includes(activeLegendFilter);
        const isPast = isAfspraakInPast(a);
        return datumMatch && operatorMatch && legendMatch && (showPast || !isPast);
      });

      if (filteredData.length === 0 && (selectedDatum || selectedOperator || activeLegendFilter)) {
        showError('Geen afspraken gevonden met de huidige filters.');
      } else if (filteredData.length === 0 && !selectedDatum && !selectedOperator && !activeLegendFilter) {
          if (afsprakenData.length === 0) {
              showError('Geen afspraken geladen. Controleer je brongegevens.');
          }
      }

      filteredData.forEach((afspraak) => {
        const primaryOperator = afspraak.operators[0];
        const emoji = operatorEmoji[primaryOperator] || "üìç";
        const isPast = isAfspraakInPast(afspraak);

        const isCurrentlySelected = selectedLatLons.some(pos =>
            Math.abs(pos.lat - afspraak.lat) < 0.000001 &&
            Math.abs(pos.lng - afspraak.lon) < 0.000001
        );

        const marker = new google.maps.Marker({
            position: { lat: afspraak.lat, lng: afspraak.lon },
            map: map,
            icon: getMarkerIcon(emoji, isCurrentlySelected, isPast),
            title: afspraak.adres,
            draggable: true
        });
        allMarkers.push(marker);
        marker.afspraakData = afspraak;

        const infoWindow = new google.maps.InfoWindow({
          content: `
              <div style="padding: 10px; border-radius: 8px; background: linear-gradient(135deg, #16213e 0%, #0f3460 100%); color: white; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);">
                  <h3 style="margin-top: 0; margin-bottom: 8px; color: #FFD700; font-size: 1.2em;">
                      <i class="fas fa-user-circle" style="margin-right: 5px;"></i>${afspraak.operators.join(", ")}
                  </h3>
                  <p style="margin: 5px 0; font-size: 0.9em;"><i class="fas fa-map-marker-alt" style="margin-right: 5px; color: #bbb;"></i>${afspraak.adres}</p>
                  <p style="margin: 5px 0; font-size: 0.9em;"><i class="fas fa-calendar-alt" style="margin-right: 5px; color: #bbb;"></i>${afspraak.datum}</p>
                  <p style="margin: 5px 0; font-size: 0.9em;"><i class="fas fa-clock" style="margin-right: 5px; color: #bbb;"></i>${afspraak.tijd}</p>
                  <p style="margin: 5px 0; font-size: 0.9em;"><i class="fas fa-info-circle" style="margin-right: 5px; color: #bbb;"></i>Status: ${afspraak.status}</p>
              </div>
          `
        });

        marker.addListener("click", () => {
          toggleMarkerSelection(marker);
          infoWindow.open(map, marker);
        });
        
        // Dragging event handlers
        marker.addListener('dragstart', () => {
          currentlyDragging = marker;
          marker.set('dragging', true);
          marker.setIcon(getMarkerIcon(emoji, true, isPast));
          marker.setZIndex(1000);
        });
        
        marker.addListener('dragend', (event) => {
          marker.set('dragging', false);
          handleMarkerDragEnd(marker, event.latLng);
        });
      });

      if (allMarkers.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        allMarkers.forEach(marker => bounds.extend(marker.getPosition()));
        map.fitBounds(bounds);
      }

      if (selectedAfspraken.length > 0) {
        updateTravelInfo();
      }
    }

    function toggleMarkerSelection(marker) {
      const index = selectedMarkers.indexOf(marker);
      if (index > -1) {
        deselectMarker(marker);
      } else {
        selectMarker(marker);
      }
      updateTravelInfo();
    }

    function selectMarker(marker) {
      if (selectedMarkers.includes(marker)) return;

      selectedMarkers.push(marker);
      selectedAfspraken.push(marker.afspraakData);

      const primaryOperator = marker.afspraakData.operators[0];
      const emoji = operatorEmoji[primaryOperator] || "üìç";
      const isPast = isAfspraakInPast(marker.afspraakData);
      marker.setIcon(getMarkerIcon(emoji, true, isPast));
    }

    function deselectMarker(marker) {
      const index = selectedMarkers.indexOf(marker);
      if (index > -1) {
        selectedMarkers.splice(index, 1);
        selectedAfspraken.splice(index, 1);

        const primaryOperator = marker.afspraakData.operators[0];
        const emoji = operatorEmoji[primaryOperator] || "üìç";
        const isPast = isAfspraakInPast(marker.afspraakData);
        marker.setIcon(getMarkerIcon(emoji, false, isPast));

        if (selectedMarkers.length < 2) {
          removeRoute();
        }
      }
    }

    function clearSelection() {
      removeRoute();

      selectedMarkers.forEach(marker => {
        const primaryOperator = marker.afspraakData.operators[0];
        const emoji = operatorEmoji[primaryOperator] || "üìç";
        const isPast = isAfspraakInPast(marker.afspraakData);
        marker.setIcon(getMarkerIcon(emoji, false, isPast));
      });

      selectedMarkers = [];
      selectedAfspraken = [];
      document.getElementById("travel-info").style.display = "none";
    }

    function removeRoute() {
        if (directionsRenderer) {
            directionsRenderer.setDirections({ routes: [] });
        }
    }

    async function updateTravelInfo() {
      const travelInfo = document.getElementById("travel-info");
      const travelDetails = document.getElementById("travel-details");

      if (selectedAfspraken.length < 2) {
        travelInfo.style.display = "none";
        removeRoute();
        return;
      }

      const sortedAfspraken = [...selectedAfspraken].sort((a, b) => {
        const dateA = parseDatumEnTijd(a.datum, a.tijd);
        const dateB = parseDatumEnTijd(b.datum, b.tijd);
        return dateA - dateB;
      });

      removeRoute();

      const waypoints = sortedAfspraken.slice(1, -1).map(afspraak => ({
          location: new google.maps.LatLng(afspraak.lat, afspraak.lon),
          stopover: true
      }));

      const origin = new google.maps.LatLng(sortedAfspraken[0].lat, sortedAfspraken[0].lon);
      const destination = new google.maps.LatLng(sortedAfspraken[sortedAfspraken.length - 1].lat, sortedAfspraken[sortedAfspraken.length - 1].lon);

      const request = {
          origin: origin,
          destination: destination,
          waypoints: waypoints,
          optimizeWaypoints: false,
          travelMode: google.maps.TravelMode.DRIVING,
          unitSystem: google.maps.UnitSystem.METRIC,
      };

      showLoading(true);
      try {
          const response = await directionsService.route(request);

          if (response.status === 'OK') {
              directionsRenderer.setDirections(response);

              const route = response.routes[0];
              const totalDistanceMeters = route.legs.reduce((sum, leg) => sum + leg.distance.value, 0);
              const totalTimeSeconds = route.legs.reduce((sum, leg) => sum + leg.duration.value, 0);

              const totalDistance = (totalDistanceMeters / 1000).toFixed(1);
              const totalTimeMinutes = Math.round(totalTimeSeconds / 60);
              const totalTimeHours = (totalTimeMinutes / 60).toFixed(1);

              let segmentsHtml = '';
              route.legs.forEach((leg, index) => {
                  const fromAfspraak = sortedAfspraken[index];
                  const toAfspraak = sortedAfspraken[index + 1];
                  const distanceKm = (leg.distance.value / 1000).toFixed(1);
                  const timeMinutes = Math.round(leg.duration.value / 60);

                  segmentsHtml += `
                    <div class="travel-segment">
                      <div><strong><i class="fas fa-map-marker-alt"></i> Van:</strong> ${fromAfspraak.adres} (${fromAfspraak.tijd})</div>
                      <div><strong><i class="fas fa-map-marker-alt"></i> Naar:</strong> ${toAfspraak.adres} (${toAfspraak.tijd})</div>
                      <div><strong><i class="fas fa-route"></i> Afstand:</strong> ${distanceKm} km</div>
                      <div><strong><i class="fas fa-clock"></i> Geschatte reistijd:</strong> ${timeMinutes} min ${liveTrafficEnabled ? '<span class="live-time-indicator"><i class="fas fa-bolt"></i>Live verkeer</span>' : ''}</div>
                    </div>
                  `;
              });

              travelDetails.innerHTML = segmentsHtml + `
                <div class="travel-segment" style="background: rgba(255, 215, 0, 0.2); border-left-color: #FFD700;">
                  <div><strong><i class="fas fa-chart-line"></i> Totale afstand:</strong> ${totalDistance} km</div>
                  <div><strong><i class="fas fa-stopwatch"></i> Totale geschatte reistijd:</strong> ${totalTimeMinutes} min (${totalTimeHours} uur) ${liveTrafficEnabled ? '<span class="live-time-indicator"><i class="fas fa-bolt"></i>Live verkeer</span>' : ''}</div>
                </div>
              `;
              travelInfo.style.display = "block";

          } else {
              showError('Geen route gevonden via Google Maps Directions. Status: ' + response.status);
              fallbackTravelInfo(sortedAfspraken);
          }
      } catch (error) {
          console.error('Error fetching Google Maps Directions:', error);
          showError('Fout bij ophalen route van Google Maps. Toon geschatte afstanden.');
          fallbackTravelInfo(sortedAfspraken);
      } finally {
          showLoading(false);
      }
    }

    function fallbackTravelInfo(sortedAfspraken) {
      const travelInfo = document.getElementById("travel-info");
      const travelDetails = document.getElementById("travel-details");

      let totalDistance = 0;
      let totalTime = 0;
      let segments = [];

      removeRoute();

      for (let i = 0; i < sortedAfspraken.length - 1; i++) {
        const from = sortedAfspraken[i];
        const to = sortedAfspraken[i + 1];

        const distance = google.maps.geometry.spherical.computeDistanceBetween(
            new google.maps.LatLng(from.lat, from.lon),
            new google.maps.LatLng(to.lat, to.lon)
        ) / 1000;

        const estimatedTime = Math.round(distance * 1.5);

        totalDistance += distance;
        totalTime += estimatedTime;

        segments.push({
          from: from.adres,
          to: to.adres,
          distance: distance.toFixed(1),
          time: estimatedTime,
          fromTime: from.tijd,
          toTime: to.tijd
        });
      }

      travelDetails.innerHTML = segments.map(segment => `
        <div class="travel-segment">
          <div><strong><i class="fas fa-map-marker-alt"></i> Van:</strong> ${segment.from} (${segment.fromTime})</div>
          <div><strong><i class="fas fa-map-marker-alt"></i> Naar:</strong> ${segment.to} (${segment.toTime})</div>
          <div><strong><i class="fas fa-route"></i> Afstand:</strong> ${segment.distance} km</div>
          <div><strong><i class="fas fa-clock"></i> Geschatte reistijd:</strong> ${segment.time} min</div>
        </div>
      `).join('') + `
        <div class="travel-segment" style="background: rgba(255, 215, 0, 0.2); border-left-color: #FFD700;">
          <div><strong><i class="fas fa-chart-line"></i> Totale afstand:</strong> ${totalDistance.toFixed(1)} km</div>
          <div><strong><i class="fas fa-stopwatch"></i> Totale geschatte reistijd:</strong> ${Math.round(totalTime)} min (${(totalTime / 60).toFixed(1)} uur)</div>
          <div style="color: #ff6b6b;"><i class="fas fa-exclamation-triangle"></i> Let op: geschatte tijden gebaseerd op vogelvlucht afstand</div>
        </div>
      `;

      travelInfo.style.display = "block";
    }

    async function handleSearch() {
      const searchTerm = document.getElementById("searchInput").value.toLowerCase().trim();

      searchResults.forEach(marker => marker.setMap(null));
      searchResults = [];

      if (!searchTerm) {
          updateMarkers();
          return;
      }

      let foundInAppointments = false;
      let markersToShowInSearch = [];

      allMarkers.forEach(marker => {
          const afspraak = marker.afspraakData;
          const searchableText = `${afspraak.adres} ${afspraak.operators.join(' ')} ${afspraak.status}`.toLowerCase();
          if (searchableText.includes(searchTerm)) {
              markersToShowInSearch.push(marker);
              foundInAppointments = true;
          } else {
             marker.setMap(null);
          }
      });

      markersToShowInSearch.forEach(marker => marker.setMap(map));

      if (foundInAppointments) {
          if (markersToShowInSearch.length === 1) {
              map.setCenter(markersToShowInSearch[0].getPosition());
              map.setZoom(15);
          } else if (markersToShowInSearch.length > 1) {
              const bounds = new google.maps.LatLngBounds();
              markersToShowInSearch.forEach(marker => bounds.extend(marker.getPosition()));
              map.fitBounds(bounds);
          }
      } else {
          showLoading(true);
          try {
              const response = await geocoder.geocode({ address: searchTerm });
              if (response.results && response.results.length > 0) {
                  const location = response.results[0].geometry.location;
                  map.setCenter(location);
                  map.setZoom(14);

                  const searchMarker = new google.maps.Marker({
                      position: location,
                      map: map,
                      icon: {
                          path: google.maps.SymbolPath.CIRCLE,
                          scale: 7,
                          fillColor: '#FFD700',
                          fillOpacity: 0.8,
                          strokeWeight: 0
                      },
                      title: response.results[0].formatted_address
                  });
                  searchResults.push(searchMarker);
              } else {
                  showError('Geen resultaten gevonden voor de zoekterm.');
              }
          } catch (error) {
              console.error('Fout tijdens geocoding:', error);
              showError('Fout bij geocoding. Probeer een ander adres.');
          } finally {
              showLoading(false);
          }
      }
    }

    async function handleMarkerDragEnd(draggedMarker, newPosition) {
        const radiusThreshold = 50; // Straal in meters om een 'drop' op een andere marker te detecteren

        let targetMarker = null;
        let minDistance = Infinity;

        // Reset alle markers naar hun normale staat
        allMarkers.forEach(marker => {
            if (marker !== draggedMarker) {
                const primaryOperator = marker.afspraakData.operators[0];
                const emoji = operatorEmoji[primaryOperator] || "üìç";
                const isPast = isAfspraakInPast(marker.afspraakData);
                const isSelected = selectedMarkers.includes(marker);
                marker.setIcon(getMarkerIcon(emoji, isSelected, isPast));
            }
        });

        // Zoek de dichtstbijzijnde marker binnen de threshold
        for (const marker of allMarkers) {
            if (marker === draggedMarker) continue;

            const distance = google.maps.geometry.spherical.computeDistanceBetween(
                newPosition,
                marker.getPosition()
            );

            if (distance < minDistance && distance < radiusThreshold) {
                minDistance = distance;
                targetMarker = marker;
            }
        }

        if (targetMarker) {
            console.log(`Marker gesleept naar de buurt van ${targetMarker.afspraakData.adres}. Wisselen van medewerkers...`);
            
            const afspraakA = draggedMarker.afspraakData;
            const afspraakB = targetMarker.afspraakData;

            // Haal de huidige operators op
            let newOperatorsA = [...afspraakA.operators];
            let newOperatorsB = [...afspraakB.operators];

            // Wissel de eerste operator van de arrays
            const primaryOperatorA = newOperatorsA.length > 0 ? newOperatorsA[0] : '';
            const primaryOperatorB = newOperatorsB.length > 0 ? newOperatorsB[0] : '';

            if (newOperatorsA.length > 0) newOperatorsA[0] = primaryOperatorB;
            else if (primaryOperatorB) newOperatorsA.push(primaryOperatorB); 

            if (newOperatorsB.length > 0) newOperatorsB[0] = primaryOperatorA;
            else if (primaryOperatorA) newOperatorsB.push(primaryOperatorA); 
            
            // Verwijder lege strings
            newOperatorsA = newOperatorsA.filter(op => op); 
            newOperatorsB = newOperatorsB.filter(op => op);

            // Update de afspraakData objecten
            afspraakA.operators = newOperatorsA;
            afspraakB.operators = newOperatorsB;

            // Update marker iconen
            draggedMarker.setIcon(getMarkerIcon(operatorEmoji[afspraakA.operators[0]] || "üìç", selectedMarkers.includes(draggedMarker), isAfspraakInPast(afspraakA)));
            targetMarker.setIcon(getMarkerIcon(operatorEmoji[afspraakB.operators[0]] || "üìç", selectedMarkers.includes(targetMarker), isAfspraakInPast(afspraakB)));

            // Stuur de update naar de Google Sheet
            await updateGoogleSheet(
                { original_datum: afspraakA.originalDatum, original_tijd: afspraakA.originalTijd, original_adres: afspraakA.originalAdres, new_operator: afspraakA.operators.join(', ') },
                { original_datum: afspraakB.originalDatum, original_tijd: afspraakB.originalTijd, original_adres: afspraakB.originalAdres, new_operator: afspraakB.operators.join(', ') }
            );

            // Zet de gesleepte marker terug naar zijn oorspronkelijke positie
            draggedMarker.setPosition({ lat: afspraakA.lat, lng: afspraakA.lon });
            
            // Update de teller
            updateCounter();

        } else {
            console.log("Marker gesleept, maar niet op een andere afspraak neergezet. Positie wordt hersteld.");
            draggedMarker.setPosition({ lat: draggedMarker.afspraakData.lat, lng: draggedMarker.afspraakData.lon });
        }
        
        currentlyDragging = null;
    }

    async function updateGoogleSheet(appData1, appData2) {
        if (!googleAppsScriptURL || googleAppsScriptURL === "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL") {
            showError("Fout: Google Apps Script URL is niet ingesteld. Kan de sheet niet bijwerken.");
            console.error("Missing Google Apps Script URL. Please update 'googleAppsScriptURL' in the code.");
            return;
        }

        const payload = {
            action: "swapOperators",
            appointments: [
                {
                    original_datum: appData1.original_datum,
                    original_tijd: appData1.original_tijd,
                    original_adres: appData1.original_adres,
                    new_operator: appData1.new_operator
                },
                {
                    original_datum: appData2.original_datum,
                    original_tijd: appData2.original_tijd,
                    original_adres: appData2.original_adres,
                    new_operator: appData2.new_operator
                }
            ]
        };

        console.log("Verstuur payload naar Apps Script:", JSON.stringify(payload, null, 2));

        try {
            showLoading(true);
            const response = await fetch(googleAppsScriptURL, {
                method: "POST",
                mode: "cors",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            });

            const result = await response.json();
            console.log("Antwoord van Apps Script:", result);

            if (response.ok && result.status === "success") {
                // Toon een subtiele melding in plaats van een alert
                const successDiv = document.createElement('div');
                successDiv.className = 'error-message';
                successDiv.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
                successDiv.style.borderColor = '#4CAF50';
                successDiv.style.color = '#4CAF50';
                successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${result.message}`;
                document.body.appendChild(successDiv);

                setTimeout(() => {
                    if (document.body.contains(successDiv)) {
                        document.body.removeChild(successDiv);
                    }
                }, 3000);
                
                // Herlaad de afspraken om zeker te zijn van consistentie
                await loadAfspraken(); 
                updateMarkers();
                updateCounter();
            } else {
                showError(`Fout bij sheet update: ${result.message || 'Onbekende fout van Apps Script.'}`);
                console.error("Apps Script response status niet succesvol:", result);
            }

        } catch (error) {
            console.error("Fout bij versturen update naar Google Apps Script:", error);
            showError("Fout bij versturen van de wijziging naar de Google Sheet. Controleer je Apps Script configuratie en netwerk.");
        } finally {
            showLoading(false);
        }
    }
  





</script>
<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQu2tdR_UHXSEhvRq0Sga15iSOq9A6dDFfGrgLmtQ5k4oJW1NsBNb604HSecpGI9gqY5AWXjTvzArJQ/pub?output=csv";

async function laadAfspraken() {
  try {
    const response = await fetch(sheetURL);
    const csvText = await response.text();

    const parsed = Papa.parse(csvText, {
      header: false,
      skipEmptyLines: true
    });

    const rows = parsed.data.slice(1); // eerste rij = headers
    let geldigeCount = 0;

    const afspraken = rows.map((cols, index) => {
      if (cols.length < 10 || !cols[2] || !cols[8] || !cols[9]) {
        console.warn("Rij " + (index + 2) + " overgeslagen: ontbrekende data of verkeerde structuur.", cols);
        return null;
      }

      geldigeCount++;
      return {
        datum: cols[0],
        medewerker: cols[1],
        klantnaam: cols[2],
        adres: cols[3],
        status: cols[4],
        tijd: cols[5],
        lat: parseFloat(cols[8]),
        lon: parseFloat(cols[9])
      };
    }).filter(a => a && !isNaN(a.lat) && !isNaN(a.lon));

    window.afspraken = afspraken;
    plaatsMarkers(afspraken);

    console.log(`‚úÖ ${geldigeCount} afspraken geladen.`);
    if (geldigeCount === 0) {
      alert("‚ö† Geen geldige afspraken gevonden. Controleer je Google Sheet structuur.");
    }
  } catch (err) {
    console.error("Fout bij laden afspraken:", err);
    alert("‚ö† Er is een fout opgetreden bij het laden van de afspraken.");
  }
}

function logConflict(afspraak1, afspraak2, verschilMin) {
  const container = document.getElementById("logList");
  const entry = document.createElement("div");
  entry.className = "conflict-entry";
  entry.innerText = `üî∂ ${afspraak1.klantnaam} (${afspraak1.tijd}) ‚Üí ${afspraak2.klantnaam} (${afspraak2.tijd}): Advies +${verschilMin} min`;
  container.appendChild(entry);
}
function clearLog() {
  const container = document.getElementById("logList");
  container.innerHTML = "";
}


let alleAfspraken = [];

function filterOpDag(dag) {
  const gefilterd = dag ? alleAfspraken.filter(a => a.datum === dag) : alleAfspraken;
  toonMarkers(gefilterd);
}

document.getElementById("dagFilter").addEventListener("change", function() {
  filterOpDag(this.value);
});

document.getElementById("zoekInput").addEventListener("input", function() {
  const zoekterm = this.value.toLowerCase();
  const resultaten = alleAfspraken.filter(a =>
    a.klantnaam.toLowerCase().includes(zoekterm) ||
    a.adres.toLowerCase().includes(zoekterm)
  );
  toonMarkers(resultaten);
});

function vulDagFilter() {
  const uniekeDagen = [...new Set(alleAfspraken.map(a => a.datum))].sort();
  const select = document.getElementById("dagFilter");
  uniekeDagen.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d;
    select.appendChild(opt);
  });
}

function wisSelectie() {
  alleMarkers.forEach(m => m.setMap(null));
  if (routePolyline) routePolyline.setMap(null);
  document.getElementById("logList").innerHTML = "";
}

let directionsService = new google.maps.DirectionsService();



function checkHaalbaarheid() {
  document.getElementById("logList").innerHTML = "";
  const alleAfspraken = window.afspraken || [];
  const afsprakenPerDag = {}
  alleAfspraken.forEach(a => {
    if (!afsprakenPerDag[a.datum]) afsprakenPerDag[a.datum] = [];
    afsprakenPerDag[a.datum].push(a);
  });
}
</script>
</body>
</html>
