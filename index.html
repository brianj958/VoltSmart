
<!DOCTYPE html>
<html>
<head>
  <title>Visuele Afsprakenkaart met Routing</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { height: 100%; width: 100%; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 999;
      background: white;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      max-height: 90%;
      overflow-y: auto;
    }
    #adviceBox {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 999;
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      width: 300px;
      max-height: 40%;
      overflow-y: auto;
    }
    label { display: block; margin-top: 6px; }
    select, button { width: 100%; padding: 6px; margin-top: 4px; }
  </style>
</head>
<body>
  <div id="controls">
    <h3>Instellingen</h3>
    <label for="date-filter">Filter op datum:</label>
    <select id="date-filter"></select>

    <h4>Afsprakenduurtijd per operator</h4>
    <label>Roelof (ğŸ‘¨â€ğŸŒ¾): <select id="duration-roelof">
      <option value="30">30 min</option><option value="45">45 min</option><option value="60" selected>60 min</option><option value="90">90 min</option>
    </select></label>
    <label>Jesse (ğŸš€): <select id="duration-jesse">
      <option value="30">30 min</option><option value="45">45 min</option><option value="60" selected>60 min</option><option value="90">90 min</option>
    </select></label>
    <label>Chanice (âœ¨): <select id="duration-chanice">
      <option value="30">30 min</option><option value="45">45 min</option><option value="60" selected>60 min</option><option value="90">90 min</option>
    </select></label>
    <label>Karlijn (ğŸŒ¸): <select id="duration-karlijn">
      <option value="30">30 min</option><option value="45">45 min</option><option value="60" selected>60 min</option><option value="90">90 min</option>
    </select></label>
    <label>Keith (ğŸŸ¡): <select id="duration-keith">
      <option value="30">30 min</option><option value="45">45 min</option><option value="60" selected>60 min</option><option value="90">90 min</option>
    </select></label>
    <label>Gio (ğŸ‘‘): <select id="duration-gio">
      <option value="30">30 min</option><option value="45">45 min</option><option value="60" selected>60 min</option><option value="90">90 min</option>
    </select></label>

    <button onclick="resetSelection()">ğŸ”„ Reset selectie</button>
    <button onclick="planRoute()">ğŸš— Bereken route</button>
  </div>

  <div id="adviceBox"><strong>Route-advies verschijnt hier na selectie.</strong></div>
  <div id="map"></div>

  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTvDRPKBT7KDONeDgekEXlN1_CMZUtX4U&callback=initMap" async defer></script>
  <script>
    let map, directionsService, directionsRenderer;
    const appointments = [];
    const markers = [];
    const selectedMarkers = [];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 52.1, lng: 5.1 },
        zoom: 8,
        styles: [{ elementType: "geometry", stylers: [{ color: "#1d2c4d" }] }]
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

      fetchAppointments();
    }

    function fetchAppointments() {
      const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQu2tdR_UHXSEhvRq0Sga15iSOq9A6dDFfGrgLmtQ5k4oJW1NsBNb604HSecpGI9gqY5AWXjTvzArJQ/pub?output=csv";
      fetch(sheetUrl)
        .then(response => response.text())
        .then(csv => {
          const rows = csv.trim().split("\n").slice(1);
          rows.forEach(row => {
            const cols = row.split(",");
            const datum = cols[0], medewerker = cols[1], klant = cols[2], adres = cols[3];
            const tijd = cols[5], lat = parseFloat(cols[8]), lon = parseFloat(cols[9]);
            if (!isNaN(lat) && !isNaN(lon)) {
              const marker = new google.maps.Marker({
                position: { lat, lng: lon },
                map: map,
                title: `${medewerker} â€“ ${klant} (${tijd})`,
                label: medewerkerIcon(medewerker),
              });
              marker.metadata = { datum, medewerker, klant, tijd, lat, lon };
              marker.addListener("click", () => toggleSelect(marker));
              markers.push(marker);
              appointments.push(marker.metadata);
            }
          });
        });
    }

    function medewerkerIcon(name) {
      const icons = {
        "Roelof": "ğŸ‘¨â€ğŸŒ¾", "Jesse": "ğŸš€", "Chanice": "âœ¨", "Karlijn": "ğŸŒ¸",
        "Keith": "ğŸŸ¡", "Gio": "ğŸ‘‘"
      };
      return icons[name] || "ğŸ“";
    }

    function toggleSelect(marker) {
      if (selectedMarkers.includes(marker)) {
        marker.setAnimation(null);
        selectedMarkers.splice(selectedMarkers.indexOf(marker), 1);
      } else {
        marker.setAnimation(google.maps.Animation.BOUNCE);
        selectedMarkers.push(marker);
      }
    }

    function resetSelection() {
      selectedMarkers.forEach(m => m.setAnimation(null));
      selectedMarkers.length = 0;
      directionsRenderer.set("directions", null);
      document.getElementById("adviceBox").innerHTML = "<strong>Route-advies verschijnt hier na selectie.</strong>";
    }

    function planRoute() {
      if (selectedMarkers.length < 2) {
        alert("Selecteer minimaal twee afspraken.");
        return;
      }

      const waypts = selectedMarkers.slice(1, -1).map(m => ({
        location: m.getPosition(), stopover: true
      }));

      directionsService.route({
        origin: selectedMarkers[0].getPosition(),
        destination: selectedMarkers[selectedMarkers.length - 1].getPosition(),
        waypoints: waypts,
        travelMode: google.maps.TravelMode.DRIVING,
        drivingOptions: {
          departureTime: new Date(),
          trafficModel: 'bestguess'
        },
        optimizeWaypoints: false
      }, (result, status) => {
        if (status === "OK") {
          directionsRenderer.setDirections(result);
          document.getElementById("adviceBox").innerHTML = "<strong>Route gevonden.</strong><br>Controle op haalbaarheid volgt in volgende versie.";
        } else {
          alert("Kon geen route plannen: " + status);
        }
      });
    }
  </script>
</body>
</html>
