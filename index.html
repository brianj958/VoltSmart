<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voltsmart Afsprakenkaart - Geoptimaliseerd Advies</title>
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:'Segoe UI',sans-serif; background:#0a1a2f; color:#fff; overflow:hidden; }
    #header { position:absolute; top:0; left:0; right:0; height:60px; background:#0d1b33; display:flex; align-items:center; padding:0 20px; box-shadow:0 2px 8px rgba(0,0,0,0.5); z-index:10; }
    #header img { height:40px; }
    #map { position:absolute; top:60px; left:0; right:0; bottom:150px; transition: all 0.3s ease-in-out; }
    #bottom-bar { position:absolute; bottom:0; left:0; right:0; height:150px; background:#12213c; display:flex; flex-direction:column; padding:10px 20px; box-sizing:border-box; box-shadow:0 -2px 8px rgba(0,0,0,0.5); }
    #top-row, #bottom-row { display:flex; align-items:center; flex:1; }
    select, button { margin-right:10px; padding:8px 12px; border:none; border-radius:6px; font-size:14px; transition: background 0.2s; }
    select { background:#1b2e4a; color:#fff; }
    button { background:#28a745; color:#fff; font-weight:bold; }
    button:hover { background:#218838; cursor:pointer; }
    #appointments-list { flex:2; overflow-x:auto; white-space:nowrap; }
    .appt-item { display:inline-block; background:#0f1a33; padding:8px 12px; margin-right:8px; border-radius:6px; font-size:13px; opacity:0.8; transition: opacity 0.2s; }
    .appt-item:hover { opacity:1; }
    #operators-list { flex:1; overflow-x:auto; white-space:nowrap; }
    .op-card { display:inline-flex; align-items:center; background:#0f1a33; padding:8px 12px; margin-right:8px; border-radius:6px; font-size:13px; opacity:0.9; transition: opacity 0.2s; }
    .op-card:hover { opacity:1; }
    .op-card span { margin-right:6px; font-size:18px; }
    #adviceBox { position:absolute; top:80px; right:20px; width:320px; max-height:calc(100% - 200px); overflow-y:auto; background:rgba(0,0,0,0.85); padding:20px; border-radius:10px; font-size:14px; box-shadow:0 4px 16px rgba(0,0,0,0.5); }
  </style>
</head>
<body>
  <div id="header">
    <img src="https://contrackt-prod.s3.eu-central-1.amazonaws.com/voltsmart_logo.png" alt="Voltsmart Logo">
  </div>
  <div id="map"></div>
  <div id="bottom-bar">
    <div id="top-row">
      <select id="date-filter"></select>
      <div id="appointments-list"></div>
    </div>
    <div id="bottom-row">
      <div id="operators-list"></div>
      <button id="advise-btn">ðŸš— Bereken Toewijzing</button>
    </div>
  </div>
  <div id="adviceBox"><strong>Selecteer een datum en klik 'Bereken Toewijzing'</strong></div>

  <script>
    const $ = id => document.getElementById(id);
    const API_KEY = 'AIzaSyDTvDRPKBT7KDONeDgekEXlN1_CMZUtX4U';
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQu2tdR_UHXSEhvRq0Sga15iSOq9A6dDFfGrgLmtQ5k4oJW1NsBNb604HSecpGI9gqY5AWXjTvzArJQ/pub?output=csv';
    const EMOJI = { Roelof:'ðŸ‘¨â€ðŸŒ¾', Jesse:'ðŸš€', Chanice:'âœ¨', Karlijn:'ðŸŒ¸', Keith:'ðŸŸ¡', Gio:'ðŸ‘‘' };
    const HOME = { Roelof:'Hemelrijk 9, Puiflijk', Chanice:'Harddraverstraat 32A, 3033 XL Rotterdam', Gio:'Savelsbos 304, 2716 HR Zoetermeer', Karlijn:'Spitael 92, 9202 HG Drachten', Jesse:'Kalf 406, 1509 BE Zaandam' };
    const BUFFER_MIN = 15, DEFAULT_CENTER={lat:52.1326,lng:5.2913}, DEFAULT_ZOOM=8;
    let map, ds, appointments=[], dates=[], markers=[], availability={}, durations={}, homeLocs={};

    async function loadMaps(){
      return new Promise(r=>{ window.initMap=r; const s=document.createElement('script'); s.src=`https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap`; s.async=true; document.head.appendChild(s); });
    }

    async function init(){
      await loadMaps();
      map = new google.maps.Map($('map'), { center: DEFAULT_CENTER, zoom: DEFAULT_ZOOM });
      ds = new google.maps.DirectionsService();
      await fetchAppointments();
      renderDateOptions();
      setupOperatorsUI();
      $('date-filter').onchange = () => renderListAndMap();
      $('advise-btn').onclick = calculateAdvice;
    }

    async function fetchAppointments(){
      const txt = await fetch(SHEET_CSV_URL).then(r => r.text());
      appointments = txt.split('\n').slice(1).map((l,i) => {
        const c = l.split(','); const d=c[0], op=c[1], cl=c[2], t=c[5], lat=parseFloat(c[8]), lng=parseFloat(c[9]);
        return d && EMOJI[op] && !isNaN(lat) && !isNaN(lng) ? { id:i, date:d, op, client:cl, time:t, loc:{lat,lng} } : null;
      }).filter(Boolean);
      dates = [...new Set(appointments.map(a=>a.date))].sort();
    }

    function renderDateOptions(){
      const df=$('date-filter'); df.innerHTML=''; dates.forEach(d=>df.add(new Option(d,d)));
      if(dates.length) renderListAndMap();
    }

    function setupOperatorsUI(){
      const opList = $('operators-list'); opList.innerHTML='';
      Object.keys(EMOJI).forEach(team => {
        availability[team] = true; durations[team] = 60;
        const card = document.createElement('div'); card.className='op-card';
        const icon = document.createElement('span'); icon.textContent = EMOJI[team];
        const lbl = document.createElement('span'); lbl.textContent = team;
        const sel = document.createElement('select'); [60,90].forEach(v=>sel.add(new Option(v+'m',v)));
        sel.value = 60; sel.onchange = () => durations[team] = +sel.value;
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=true;
        cb.style.marginLeft='8px'; cb.onchange = () => availability[team] = cb.checked;
        card.append(icon, lbl, sel, cb);
        opList.appendChild(card);
      });
    }

    function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers = []; }

    function renderListAndMap(){
      const date = $('date-filter').value;
      const listDiv = $('appointments-list'); listDiv.innerHTML='';
      clearMarkers();
      const filtered = appointments.filter(a=>a.date===date).sort((a,b)=>a.time.localeCompare(b.time));
      filtered.forEach(a=>{
        const div = document.createElement('div'); div.className='appt-item';
        div.textContent = `${a.time} ${EMOJI[a.op]} ${a.client}`;
        listDiv.appendChild(div);
        const m = new google.maps.Marker({ position:a.loc, map, label:{ text: EMOJI[a.op], fontSize:'16px' } });
        markers.push(m);
      });
      fitMap(filtered);
    }

    function fitMap(items){
      if(!items.length){ map.setCenter(DEFAULT_CENTER); map.setZoom(DEFAULT_ZOOM); return; }
      const bounds = new google.maps.LatLngBounds(); items.forEach(a=>bounds.extend(a.loc)); map.fitBounds(bounds);
    }

    async function calculateAdvice(){
      const date = $('date-filter').value;
      const filtered = appointments.filter(a=>a.date===date).sort((a,b)=>a.time.localeCompare(b.time));
      if(!filtered.length){ $('adviceBox').innerHTML=`<strong>Geen afspraken voor ${date}</strong>`; return; }
      const ops = Object.keys(EMOJI).filter(o=> availability[o] && HOME[o]); if(!ops.length){ $('adviceBox').innerHTML=`<strong>Geen beschikbare medewerkers</strong>`; return; }
      const assign={}, cursors={}, totalTime={}, totalDist={}; ops.forEach(o=>{ assign[o]=[]; cursors[o]=new Date(`${date}T${filtered[0].time}:00`); totalTime[o]=0; totalDist[o]=0; });
      if(Object.keys(homeLocs).length!==ops.length){ const geocoder=new google.maps.Geocoder(); for(const o of ops){ if(!homeLocs[o]){ const res=await new Promise(r=>geocoder.geocode({address:HOME[o]},r)); homeLocs[o]=res[0].geometry.location; } } }
      let adviceHtml=`<strong>Advies voor ${date}:</strong><br><ul>`;
      for(const app of filtered){ let bestOp=null,bestScore=Infinity,bestArrival=null,bestLeg=null; for(const op of ops){ const origin=assign[op].length?assign[op].slice(-1)[0].loc:homeLocs[op]; const depart=cursors[op]; const {travelMs,distanceM,leg}=await new Promise(r=>ds.route({ origin,destination:app.loc,travelMode:'DRIVING',drivingOptions:{departureTime:depart,trafficModel:'bestguess'} },resp=>{const lg=resp.routes[0].legs[0];const secs=lg.duration_in_traffic?.value||lg.duration.value;r({travelMs:secs*1000,distanceM:lg.distance.value,leg:lg});})); const arrival=new Date(depart.getTime()+travelMs); const scheduled=new Date(`${app.date}T${app.time}:00`); const delay=arrival>scheduled?(arrival-scheduled)/60000:0; const score=travelMs+delay*60000; if(score<bestScore){ bestScore=score; bestOp=op; bestArrival=arrival; bestLeg={travelMs,distanceM}; } } const sched=new Date(`${app.date}T${app.time}:00`); if(bestArrival>sched){ adviceHtml+=`<li>${EMOJI[bestOp]} ${bestOp} - verplaats ${app.client} om ${app.time} naar ${bestArrival.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</li>`; } else { adviceHtml+=`<li>${EMOJI[bestOp]} ${bestOp} - plan ${app.client} om ${app.time}</li>`; } assign[bestOp].push({loc:app.loc}); totalTime[bestOp]+=bestLeg.travelMs; totalDist[bestOp]+=bestLeg.distanceM; const next=new Date(bestArrival.getTime()); next.setMinutes(next.getMinutes()+durations[bestOp]+BUFFER_MIN); cursors[bestOp]=next; }
      adviceHtml+='</ul><br><strong>Totaal per medewerker:</strong><ul>';
      ops.forEach(op=>{ const t=totalTime[op], hr=Math.floor(t/3600000), mn=Math.round((t%3600000)/60000), km=(totalDist[op]/1000).toFixed(1); adviceHtml+=`<li>${EMOJI[op]} ${op}: ${hr}u ${mn}m reistijd, ${km} km</li>`; });
      adviceHtml+='</ul>';
      $('adviceBox').innerHTML=adviceHtml;
    }

    // Start applicatie
    init();
  </script>
</body>
</html>
