<!DOCTYPE html>
<html>
<head>
  <title>Voltsmart Afsprakenkaart</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: linear-gradient(180deg, #0a1a2f, #1b2e4a); color: white; }
    #map { height: 100vh; width: 100vw; z-index: 1; position: absolute; top: 0; left: 0; }
    #sidebar {
      position: absolute; top: 0; left: 0; width: 360px; height: 100vh;
      background: rgba(10, 20, 40, 0.97); padding: 20px 18px 12px 18px;
      box-sizing: border-box; overflow-y: auto; z-index: 999;
      box-shadow: 2px 0 8px rgba(0,0,0,0.23);
    }
    #logo { text-align: center; margin-bottom: 18px; }
    #logo img { max-width: 190px; }
    h2 { font-size: 20px; margin-bottom: 10px; color: #ffd700; }
    label, select, button { display: block; width: 100%; margin-top: 10px; }
    select, button {
      padding: 7px; border-radius: 6px; border: none;
    }
    button {
      background: #ffd700; color: #0a1a2f; font-weight: bold; cursor: pointer; margin-top: 18px;
    }
    #adviceBox {
      position: absolute; bottom: 10px; right: 10px; width: 370px; max-height: 48%;
      overflow-y: auto; background: rgba(0,0,0,0.88); color: white;
      padding: 15px; border-radius: 13px; z-index: 999; font-size: 16px;
      box-shadow: 0 0 18px 0 rgba(32,34,72,0.16);
    }
    .marker-selected { filter: drop-shadow(0 0 10px #ffd700); }
    .conflict { color: #ff5252; font-weight: bold; }
    .saving { color: #4caf50; font-weight: bold; }
    .route-step { margin-bottom: 7px; }
    .flex { display: flex; align-items: center; }
    .region { font-size:13px; color: #72e1ff; margin-left: 6px;}
    .checkbox-row { display: flex; align-items: center; gap: 6px; margin-top: 5px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <div id="logo">
      <img src="ChatGPT Image 23 jul 2025, 20_18_11 (1).png" alt="Voltsmart Logo">
    </div>
    <h2>Afspraken & Instellingen</h2>
    <label for="date-filter">Datum:</label>
    <select id="date-filter"></select>

    <h2>Afspraakduur per Operator</h2>
    <label>Roelof (üë®‚Äçüåæ): <select id="duration-roelof"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></label>
    <label>Jesse (üöÄ): <select id="duration-jesse"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></label>
    <label>Chanice (‚ú®): <select id="duration-chanice"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></label>
    <label>Karlijn (üå∏): <select id="duration-karlijn"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></label>
    <label>Keith (üü°): <select id="duration-keith"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></label>
    <label>Gio (üëë): <select id="duration-gio"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></label>

    <h2>Beschikbaarheid medewerkers</h2>
    <div id="availability"></div>

    <button onclick="resetSelection()">üîÑ Reset selectie</button>
    <button onclick="planRoute()">üöó Bereken route & advies</button>
  </div>

  <div id="map"></div>
  <div id="adviceBox">
    <strong>Klik minimaal twee afspraken op de kaart, klik daarna op 'Bereken route & advies'.</strong>
  </div>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTvDRPKBT7KDONeDgekEXlN1_CMZUtX4U&callback=initMap" async defer></script>
<script>
/* ------------- CONFIG & HELPERS ------------- */
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQu2tdR_UHXSEhvRq0Sga15iSOq9A6dDFfGrgLmtQ5k4oJW1NsBNb604HSecpGI9gqY5AWXjTvzArJQ/pub?output=csv";
const OPERATOR_EMOJI = { Roelof: "üë®‚Äçüåæ", Jesse: "üöÄ", Chanice: "‚ú®", Karlijn: "üå∏", Keith: "üü°", Gio: "üëë" };
const OPERATOR_REGION = {
  Roelof: "Noord-Brabant",
  Chanice: "Zuid-Holland & Utrecht",
  Gio: "Zuid-Holland & Zeeland",
  Karlijn: "Groningen",
  Jesse: "Noord-Holland (flexibel)"
};
// Medewerker-adressen voor startpunt
const OPERATOR_HOME_ADDRESS = {
  Roelof: "Hemelrijk 9, Puiflijk",
  Chanice: "Harddraverstraat 32A, 3033 XL Rotterdam",
  Gio: "Savelsbos 304, 2716 HR Zoetermeer",
  Karlijn: "Spitael 92, 9202 HG Drachten",
  Jesse: "Kalf 406, 1509 BE Zaandam"
};
const KM_COST = 0.21, TIME_COST = 35; // ‚Ç¨ per km / per uur

let map, directionsService, directionsRenderer;
let appointments = [], markers = [], selectedMarkers = [], filteredAppointments = [];
let medewerkerBeschikbaar = {
  Roelof: true, Jesse: true, Chanice: true, Karlijn: true, Keith: true, Gio: true
};
let geocodedHomes = {}; // Voor geocoded home coordinates

function parseDateString(str) {
  if (!str) return new Date(NaN);
  const iso = Date.parse(str);
  if (!isNaN(iso)) return new Date(iso);
  const parts = str.split(/[\/-]/);
  if (parts.length === 3) {
    const [d, m, y] = parts.map(p => parseInt(p, 10));
    const year = y < 100 ? 2000 + y : y;
    return new Date(year, m - 1, d);
  }
  return new Date(str);
}

function parseTime(str) {
  const [h, m] = str.split(":").map(Number);
  return h * 60 + m;
}

function formatTime(min) {
  const h = Math.floor(min / 60);
  const m = min % 60;
  return String(h).padStart(2, "0") + ":" + String(m).padStart(2, "0");
}

function getDurationForOperator(name) {
  const el = document.getElementById("duration-" + name.toLowerCase());
  return el ? parseInt(el.value, 10) : 60;
}

/* ------------ INIT ------------ */
function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 52.1, lng: 5.1 },
    zoom: 7,
    mapTypeId: "roadmap"
  });
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true });
  fetchAppointments();
  renderBeschikbaarheidsCheckboxen();
}

/* ------------ DATA LAAD EN MARKERS ------------ */
function fetchAppointments() {
  fetch(SHEET_URL)
    .then(r => r.text())
    .then(csv => {
      const rows = csv.split("\n").slice(1);
      appointments = [];
      rows.forEach(row => {
        const [datum, medewerker, klant, adres, status, tijd, , , lat, lon] = row.split(",");
        if (lat && lon && !isNaN(parseFloat(lat))) {
          appointments.push({ datum, medewerker, klant, adres, status, tijd, lat: parseFloat(lat), lon: parseFloat(lon) });
        }
      });
      fillDateFilter();
      showMarkersForDate(getSelectedDate());
    });
}

/* ------------ DATUMFILTER ------------ */
function fillDateFilter() {
  const sel = document.getElementById("date-filter");
  sel.innerHTML = "";
  const dates = [...new Set(appointments.map(a => a.datum))]
    .filter(d => d)
    .sort((a, b) => parseDateString(a) - parseDateString(b));
  dates.forEach(date => {
    sel.innerHTML += `<option value="${date}">${date}</option>`;
  });
  // Standaard eerstvolgende datum selecteren
  const today = new Date().toISOString().slice(0,10);
  const firstFuture = dates.find(d => d >= today) || dates[0];
  sel.value = firstFuture;
  sel.onchange = () => showMarkersForDate(sel.value);
}

function getSelectedDate() {
  return document.getElementById("date-filter").value;
}

/* ------------ MARKERS TONEN ------------ */
function showMarkersForDate(date) {
  // Clear
  markers.forEach(m => m.setMap(null));
  markers = []; selectedMarkers = [];
  filteredAppointments = appointments.filter(a => a.datum === date);
  if (filteredAppointments.length) {
    filteredAppointments.forEach(a => {
      const marker = new google.maps.Marker({
        position: { lat: a.lat, lng: a.lon },
        map,
        title: `${a.medewerker} ‚Äì ${a.klant} (${a.tijd})`,
        label: { text: OPERATOR_EMOJI[a.medewerker] || "üìç", fontSize: "20px" }
      });
      marker.metadata = a;
      marker.addListener("click", () => toggleSelect(marker));
      markers.push(marker);
    });
    const bounds = new google.maps.LatLngBounds();
    markers.forEach(m => bounds.extend(m.getPosition()));
    map.fitBounds(bounds);
  } else {
    map.setCenter({ lat: 52.1, lng: 5.1 });
    map.setZoom(7);
  }
  const baseMsg = "<strong>Klik minimaal twee afspraken op de kaart, klik daarna op 'Bereken route & advies'.</strong>";
  document.getElementById("adviceBox").innerHTML = baseMsg + buildUnassignedAdvice(date);
}

/* ------------ SELECTIE ------------ */
function toggleSelect(marker) {
  if (selectedMarkers.includes(marker)) {
    marker.setIcon(null);
    marker.setAnimation(null);
    marker.label = { text: OPERATOR_EMOJI[marker.metadata.medewerker] || "üìç", fontSize: "20px" };
    selectedMarkers = selectedMarkers.filter(m => m !== marker);
    marker.setZIndex(1);
  } else {
    marker.setAnimation(google.maps.Animation.BOUNCE);
    marker.label = { text: OPERATOR_EMOJI[marker.metadata.medewerker] || "üìç", fontSize: "20px" };
    selectedMarkers.push(marker);
    marker.setZIndex(999);
  }
}

/* ------------ RESET ------------ */
function resetSelection() {
  selectedMarkers.forEach(m => { m.setAnimation(null); m.setIcon(null); });
  selectedMarkers = [];
  directionsRenderer.set("directions", null);
  const baseMsg = "<strong>Klik minimaal twee afspraken op de kaart, klik daarna op 'Bereken route & advies'.</strong>";
  document.getElementById("adviceBox").innerHTML = baseMsg + buildUnassignedAdvice(getSelectedDate());
}

/* ------------ BESCHIKBAARHEID CHECKBOXEN ------------ */
function renderBeschikbaarheidsCheckboxen() {
  const div = document.getElementById("availability");
  div.innerHTML = "";
  Object.keys(OPERATOR_HOME_ADDRESS).forEach(naam => {
    div.innerHTML += `
      <div class="checkbox-row">
        <input type="checkbox" id="chk_${naam}" checked onchange="toggleBeschikbaarheid('${naam}')"/>
        <label for="chk_${naam}">${naam} (${OPERATOR_EMOJI[naam] || ""})</label>
      </div>`;
  });
}
function toggleBeschikbaarheid(naam) {
  medewerkerBeschikbaar[naam] = document.getElementById("chk_" + naam).checked;
}

/* ------------ ROUTE EN ADVIES ------------ */
function planRoute() {
  // Werkelijk per medewerker routes & advies berekenen!
  adviseerBesteMedewerkerPerRoute();
}

/* ------------ ADVIES MET GOOGLE DIRECTIONS API ------------ */
async function adviseerBesteMedewerkerPerRoute() {
  document.getElementById("adviceBox").innerHTML = "<b>Route-advies per medewerker wordt berekend...</b>";
  // Haal geselecteerde datum op
  const date = getSelectedDate();
  // Verzamel afspraken per medewerker voor deze dag
  let advies = "<b>Advies per medewerker:</b><ul style='padding-left:16px'>";
  // Eerst alle home-adressen geocoderen (indien nodig)
  await geocodeAllHomes();

  for (let naam in OPERATOR_HOME_ADDRESS) {
    if (!medewerkerBeschikbaar[naam]) {
      advies += `<li>${OPERATOR_EMOJI[naam] || naam} <b>${naam}</b>: <span class='conflict'>Niet beschikbaar</span></li>`;
      continue;
    }
    const afspraken = appointments.filter(a => a.datum === date && a.medewerker === naam);
    if (!afspraken.length) {
      advies += `<li>${OPERATOR_EMOJI[naam] || naam} <b>${naam}</b>: <span class='conflict'>Geen route (geen afspraken)</span></li>`;
      continue;
    }
    // Sorteer afspraken op tijd
    afspraken.sort((a, b) => a.tijd.localeCompare(b.tijd));
    const points = [geocodedHomes[naam], ...afspraken.map(a => ({ lat: a.lat, lng: a.lon }))];

    // Bereken route via Directions API
    let totaalAfstand = 0, totaalTijd = 0;
    let result;
    try {
      result = await directionsPromise(points);
    } catch (e) {
      advies += `<li>${OPERATOR_EMOJI[naam] || naam} <b>${naam}</b>: <span class='conflict'>Route fout (${e.message})</span></li>`;
      continue;
    }
    if (result && result.routes.length) {
      const legs = result.routes[0].legs;
      legs.forEach(leg => {
        totaalAfstand += (leg.distance.value || 0)/1000;
        totaalTijd += (leg.duration_in_traffic ? leg.duration_in_traffic.value : leg.duration.value)/60;
      });
      const besparing = Math.round((totaalAfstand * KM_COST) + (totaalTijd/60 * TIME_COST));
      advies += `<li>${OPERATOR_EMOJI[naam] || naam} <b>${naam}</b>: ${afspraken.length} afspraken, <span class="saving">¬±${totaalAfstand.toFixed(1)} km, ${Math.round(totaalTijd)} min, indicatief ‚Ç¨${besparing}</span></li>`;
    } else {
      advies += `<li>${OPERATOR_EMOJI[naam] || naam} <b>${naam}</b>: <span class='conflict'>Geen route gevonden</span></li>`;
    }
  }
  advies += "</ul>";
  advies += buildUnassignedAdvice(date);
  document.getElementById("adviceBox").innerHTML = advies;
}

/* ------------ HULPFUNCTIES ------------ */
function directionsPromise(points) {
  return new Promise((resolve, reject) => {
    if (points.length < 2) return reject(new Error("Te weinig punten voor route"));
    const origin = points[0];
    const destination = points[points.length-1];
    const waypoints = points.slice(1, -1).map(p => ({ location: p, stopover: true }));
    directionsService.route({
      origin, destination, waypoints,
      travelMode: google.maps.TravelMode.DRIVING,
      drivingOptions: { departureTime: new Date(), trafficModel: "bestguess" }
    }, (result, status) => {
      if (status === "OK") resolve(result);
      else reject(new Error(status));
    });
  });
}

// Geocode home-adressen naar lat/lon
async function geocodeAllHomes() {
  for (let naam in OPERATOR_HOME_ADDRESS) {
    if (!geocodedHomes[naam]) {
      const coords = await geocodeAddress(OPERATOR_HOME_ADDRESS[naam]);
      geocodedHomes[naam] = coords;
    }
  }
}
function geocodeAddress(address) {
  return new Promise((resolve, reject) => {
    const gc = new google.maps.Geocoder();
    gc.geocode({ address }, (results, status) => {
      if (status === "OK" && results[0]) {
        const loc = results[0].geometry.location;
        resolve({ lat: loc.lat(), lng: loc.lng() });
      } else {
        resolve({ lat: 52.1, lng: 5.1 }); // fallback Nederland
      }
    });
  });
}

function computeBestEmployee(appt, date) {
  let best = null;
  let bestScore = Infinity;
  let bestShift = 0;
  let bestTime = appt.tijd;
  for (let naam in OPERATOR_HOME_ADDRESS) {
    if (!medewerkerBeschikbaar[naam]) continue;
    const schedule = appointments
      .filter(a => a.datum === date && a.medewerker === naam)
      .sort((a, b) => parseTime(a.tijd) - parseTime(b.tijd));
    const duration = getDurationForOperator(naam);
    const desired = parseTime(appt.tijd);
    let start = desired;
    for (let i = 0; i < schedule.length; i++) {
      const sStart = parseTime(schedule[i].tijd);
      const sEnd = sStart + duration;
      if (start + duration <= sStart) break;
      start = Math.max(start, sEnd);
    }
    const diff = Math.abs(start - desired);
    const score = schedule.length * 10000 + diff;
    if (score < bestScore) {
      bestScore = score;
      best = naam;
      bestShift = start - desired;
      bestTime = formatTime(start);
    }
  }
  return { employee: best, shift: bestShift, newTime: bestTime };
}

function buildUnassignedAdvice(date) {
  const unassigned = appointments.filter(a => a.datum === date && (!a.medewerker || a.medewerker.trim() === ""));
  if (!unassigned.length) return "";
  let html = `<b>Onverdeelde afspraken (${unassigned.length}):</b><ul style='padding-left:16px'>`;
  unassigned.forEach(a => {
    const info = computeBestEmployee(a, date);
    if (!info.employee) {
      html += `<li>${a.klant} (${a.tijd}) ‚Üí <span class='conflict'>Geen medewerker beschikbaar</span></li>`;
    } else {
      const verschuif = info.shift ? `verplaats ${Math.abs(info.shift)} min naar ${info.newTime}` : 'geen verschuiving nodig';
      html += `<li>${a.klant} (${a.tijd}) ‚Üí <b>${info.employee}</b> (${verschuif})</li>`;
    }
  });
  html += '</ul>';
  return html;
}
</script>
</body>
</html>
