<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voltsmart Afsprakenkaart</title>
  <style>
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: #f4f6f8; color: #333; }
    #map { height: 100vh; width: calc(100% - 300px); position: absolute; top: 0; right: 0; }
    #sidebar {
      position: absolute; top: 0; left: 0; width: 300px; height: 100vh;
      background: #fff; padding: 20px; overflow-y: auto; box-shadow: 2px 0 8px rgba(0,0,0,0.1);
    }
    #logo { text-align: center; margin-bottom: 20px; }
    #logo img { max-width: 180px; }
    h2 { font-size: 18px; margin: 20px 0 10px; color: #0052cc; border-bottom: 1px solid #e1e1e1; padding-bottom: 5px; }
    .section { margin-bottom: 15px; }
    .field { margin-bottom: 10px; }
    label { display: block; font-weight: 500; margin-bottom: 5px; }
    select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    .grid-two { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 8px; }
    .checkbox-row input { margin-right: 8px; }
    button {
      width: 100%; padding: 10px; margin-top: 10px;
      border: none; border-radius: 4px;
      background: #0052cc; color: white; font-size: 14px; cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #003d99; }
    #adviceBox {
      position: absolute; bottom: 20px; right: 20px; width: 280px;
      background: rgba(255,255,255,0.95); color: #333;
      padding: 15px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 14px; line-height: 1.4;
    }
    ul { margin: 8px 0 0 16px; padding: 0; }
  </style>
</head>
<body>
  <div id="sidebar">
    <div id="logo">
      <img src="https://cdn.prod.website-files.com/68503ddc6fb75a92cad47e2a/686c04721a3b9d5a4dc5c9a0_Group%2032%20(1).svg" alt="Voltsmart Logo">
    </div>

    <div class="section">
      <h2>Afspraken &amp; Instellingen</h2>
      <div class="field">
        <label for="date-filter">Datum</label>
        <select id="date-filter"></select>
      </div>
    </div>

    <div class="section">
      <h2>Afspraakduur per Operator</h2>
      <div class="grid-two">
        <div class="field"><label for="duration-roelof">Roelof (üë®‚Äçüåæ)</label><select id="duration-roelof"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></div>
        <div class="field"><label for="duration-jesse">Jesse (üöÄ)</label><select id="duration-jesse"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></div>
        <div class="field"><label for="duration-chanice">Chanice (‚ú®)</label><select id="duration-chanice"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></div>
        <div class="field"><label for="duration-karlijn">Karlijn (üå∏)</label><select id="duration-karlijn"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></div>
        <div class="field"><label for="duration-keith">Keith (üü°)</label><select id="duration-keith"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></div>
        <div class="field"><label for="duration-gio">Gio (üëë)</label><select id="duration-gio"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></div>
      </div>
    </div>

    <div class="section">
      <h2>Beschikbaarheid medewerkers</h2>
      <div id="availability"></div>
    </div>

    <button onclick="resetSelection()">üîÑ Reset selectie</button>
    <button onclick="planRoute()">üöó Bereken route &amp; advies</button>
  </div>

  <div id="map"></div>
  <div id="adviceBox">
    <strong>Klik minimaal twee afspraken op de kaart, klik daarna op 'Bereken route &amp; advies'.</strong>
  </div>

  <!-- Jouw logica v√≥√≥r de Maps API laden -->
  <script>
    window.initMap = initMap;  // maak callback beschikbaar

    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQu2tdR_UHXSEhvRq0Sga15iSOq9A6dDFfGrgLmtQ5k4oJW1NsBNb604HSecpGI9gqY5AWXjTvzArJQ/pub?output=csv";
    const OPERATOR_EMOJI = { Roelof:"üë®‚Äçüåæ", Jesse:"üöÄ", Chanice:"‚ú®", Karlijn:"üå∏", Keith:"üü°", Gio:"üëë" };
    const OPERATOR_HOME_ADDRESS = {
      Roelof:"Hemelrijk 9, Puiflijk",
      Chanice:"Harddraverstraat 32A, 3033 XL Rotterdam",
      Gio:"Savelsbos 304, 2716 HR Zoetermeer",
      Karlijn:"Spitael 92, 9202 HG Drachten",
      Jesse:"Kalf 406, 1509 BE Zaandam",
      Keith:"Jouw Straatnaam 123, 1234 AB JouwPlaats"
    };
    const KM_COST = 0.21, TIME_COST = 35;

    let map, directionsService, directionsRenderer;
    let appointments = [], markers = [], selectedMarkers = [], filteredAppointments = [];
    let medewerkerBeschikbaar = {}, geocodedHomes = {};

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), { center:{lat:52.1,lng:5.1}, zoom:7 });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers:true });
      Object.keys(OPERATOR_HOME_ADDRESS).forEach(n=>medewerkerBeschikbaar[n]=true);
      fetchAppointments();
      renderBeschikbaarheidsCheckboxen();
    }

    function fetchAppointments() {
      fetch(SHEET_URL).then(r=>r.text()).then(csv=>{
        const rows = csv.trim().split(/\r?\n/).slice(1);
        appointments = rows.map(row=>{
          const cols = row.split(",");
          // haal lon, lat van het eind
          const lon = parseFloat(cols.pop()), lat = parseFloat(cols.pop());
          const [datum, medewerker, klant, adres, status, tijd] = cols;
          return { datum, medewerker, klant, adres, status, tijd, lat, lon };
        }).filter(a=>!isNaN(a.lat) && !isNaN(a.lon));
        console.log("Gelezen afspraken:", appointments.length);
        fillDateFilter();
        showMarkersForDate(getSelectedDate());
      }).catch(err=>console.error("CSV laden mislukt:",err));
    }

    function fillDateFilter() {
      const sel = document.getElementById("date-filter");
      const dates = [...new Set(appointments.map(a=>a.datum))].sort((a,b)=>new Date(a)-new Date(b));
      sel.innerHTML = dates.map(d=>`<option>${d}</option>`).join("");
      sel.value = dates.find(d=>d>=new Date().toISOString().slice(0,10))||dates[0]||"";
      sel.onchange = ()=>showMarkersForDate(sel.value);
    }
    function getSelectedDate(){ return document.getElementById("date-filter").value; }

    function showMarkersForDate(date) {
      markers.forEach(m=>m.setMap(null));
      markers=[]; selectedMarkers=[];
      filteredAppointments = appointments.filter(a=>a.datum===date);
      if(!filteredAppointments.length){
        document.getElementById("adviceBox").innerHTML = "<strong>Geen afspraken op deze datum.</strong>";
        return;
      }
      filteredAppointments.forEach(a=>{
        const m = new google.maps.Marker({
          position:{lat:a.lat,lng:a.lon}, map,
          title:`${a.medewerker} ‚Äì ${a.klant} (${a.tijd})`,
          label:{text:OPERATOR_EMOJI[a.medewerker],fontSize:"20px"}
        });
        m.metadata = a;
        m.addListener("click",()=>toggleSelect(m));
        markers.push(m);
      });
      const bounds = new google.maps.LatLngBounds();
      markers.forEach(m=>bounds.extend(m.getPosition()));
      map.fitBounds(bounds);
      document.getElementById("adviceBox").innerHTML = "<strong>Klik minimaal twee afspraken...</strong>";
    }

    function toggleSelect(m){
      if(selectedMarkers.includes(m)){
        m.setAnimation(null);
        selectedMarkers = selectedMarkers.filter(x=>x!==m);
      } else {
        m.setAnimation(google.maps.Animation.BOUNCE);
        selectedMarkers.push(m);
      }
    }

    function resetSelection(){
      selectedMarkers.forEach(m=>m.setAnimation(null));
      selectedMarkers=[];
      directionsRenderer.setDirections({routes:[]});
      document.getElementById("adviceBox").innerHTML = "<strong>Klik minimaal twee afspraken...</strong>";
    }

    function renderBeschikbaarheidsCheckboxen(){
      const div = document.getElementById("availability");
      div.innerHTML="";
      Object.keys(OPERATOR_HOME_ADDRESS).forEach(n=>{
        div.innerHTML+=
          `<div class="checkbox-row">
             <input type="checkbox" id="chk_${n}" checked onchange="toggleBeschikbaarheid('${n}')">
             <label for="chk_${n}">${n} (${OPERATOR_EMOJI[n]})</label>
           </div>`;
      });
    }
    function toggleBeschikbaarheid(n){
      medewerkerBeschikbaar[n] = !medewerkerBeschikbaar[n];
    }

    function planRoute(){
      if(selectedMarkers.length<2){
        alert("Selecteer minimaal twee afspraken.");
        return;
      }
      adviseer();
    }

    async function adviseer(){
      document.getElementById("adviceBox").textContent = "Route-advies wordt berekend‚Ä¶";
      await geocodeHomes();
      let best={cost:Infinity}, bestRoute;
      for(let naam in OPERATOR_HOME_ADDRESS){
        if(!medewerkerBeschikbaar[naam]) continue;
        const thuis = geocodedHomes[naam];
        const stops = selectedMarkers.map(m=>({lat:m.metadata.lat,lng:m.metadata.lon}));
        const pts = [thuis, ...stops];
        let res;
        try{
          res = await routePromise(pts);
        }catch{
          continue;
        }
        const {legs, waypoint_order} = res.routes[0];
        // bereken kosten
        const stats = legs.reduce((acc,leg)=>({
          dist: acc.dist + leg.distance.value/1000,
          time: acc.time + leg.duration.value/60
        }),{dist:0,time:0});
        const cost = stats.dist*KM_COST + (stats.time/60)*TIME_COST;
        if(cost<best.cost){
          best={naam,emoji:OPERATOR_EMOJI[naam],stats,cost,legs,waypoint_order,stops};
          bestRoute = res;
        }
      }
      if(!bestRoute){
        document.getElementById("adviceBox").textContent = "Geen medewerker beschikbaar voor route.";
        return;
      }
      // toon route
      directionsRenderer.setDirections(bestRoute);
      // advies pop-up: hoeveel verzetten?
      const {legs, waypoint_order, stops} = best;
      // bouw geordende stops
      const ordered = waypoint_order.map(i=>selectedMarkers[i]).concat([selectedMarkers[selectedMarkers.length-1]]);
      const suggestions = [];
      for(let j=1;j<legs.length;j++){
        const leg = legs[j];
        const prev = ordered[j-1].metadata, next = ordered[j].metadata;
        const parseM = t=>{const [h,m]=t.split(":");return parseInt(h)*60+parseInt(m);};
        const schedInterval = parseM(next.tijd) - parseM(prev.tijd);
        const travel = Math.round(leg.duration.value/60);
        const diff = schedInterval - travel;
        if(diff<0) suggestions.push(`${next.klant} ${Math.abs(diff)}‚ÄØmin eerder plannen.`);
        else if(diff>0) suggestions.push(`${next.klant} ${diff}‚ÄØmin later plannen.`);
        else suggestions.push(`${next.klant} precies op tijd.`);
      }
      alert("Verplaatsadvies:\n" + suggestions.join("\n"));
      // update sidebar advies
      document.getElementById("adviceBox").innerHTML =
        `<strong>Medewerker: ${best.emoji} ${best.naam}</strong>
         <ul>
           <li>Stops: ${selectedMarkers.length}</li>
           <li>Afstand: ${best.stats.dist.toFixed(1)} km</li>
           <li>Tijd: ${Math.round(best.stats.time)} min</li>
           <li>Kosten: ‚Ç¨${Math.round(best.cost)}</li>
         </ul>`;
    }

    function routePromise(pts){
      return new Promise((res,rej)=>{
        directionsService.route({
          origin: pts[0],
          destination: pts[pts.length-1],
          waypoints: pts.slice(1,-1).map(p=>({location:p,stopover:true})),
          travelMode:"DRIVING",
          optimizeWaypoints:true,
          drivingOptions:{departureTime:new Date(),trafficModel:"bestguess"}
        },(r,s)=> s==="OK"?res(r):rej(s));
      });
    }

    async function geocodeHomes(){
      const geocoder = new google.maps.Geocoder();
      for(let n in OPERATOR_HOME_ADDRESS){
        if(!geocodedHomes[n]){
          geocodedHomes[n] = await new Promise(r=>{
            geocoder.geocode({address:OPERATOR_HOME_ADDRESS[n]},(results,status)=>{
              if(status==="OK"){
                const loc = results[0].geometry.location;
                r({lat:loc.lat(),lng:loc.lng()});
              } else {
                r({lat:52.1,lng:5.1});
              }
            });
          });
        }
      }
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTvDRPKBT7KDONeDgekEXlN1_CMZUtX4U&callback=initMap">
  </script>
</body>
</html>
