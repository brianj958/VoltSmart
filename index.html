<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voltsmart Afsprakenkaart</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #0052cc;
      --primary-dark: #003d99;
      --bg: #f4f6f8;
      --sidebar-bg: #ffffff;
      --text: #333333;
      --shadow: rgba(0, 0, 0, 0.1);
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    html, body { height:100%; background: var(--bg); font-family: 'Inter', sans-serif; color: var(--text); }
    .container { display: flex; height:100%; }
    aside {
      width: 300px; background: var(--sidebar-bg);
      padding: 20px; overflow-y: auto;
      box-shadow: 2px 0 8px var(--shadow);
    }
    main { flex:1; position: relative; }
    #map { width:100%; height:100%; }
    h1 { font-size: 20px; margin-bottom: 16px; color: var(--primary); }
    h2 { font-size: 16px; margin:24px 0 8px; border-bottom:1px solid #e0e0e0; padding-bottom:4px; color: var(--primary); }
    label { display: block; margin-bottom: 6px; font-weight:600; }
    select, button { width:100%; }
    select {
      padding:8px; border:1px solid #ccc; border-radius:4px;
      background:#fff; appearance:none;
    }
    .grid-two { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .checkbox-row { display:flex; align-items:center; margin-bottom:10px;}
    .checkbox-row input { margin-right:8px; }
    button {
      margin-top:10px; padding:10px; border:none; border-radius:4px;
      background: var(--primary); color:#fff; font-weight:600; cursor:pointer;
      transition: background 0.2s;
    }
    button:hover { background: var(--primary-dark); }
    #adviceBox {
      position:absolute; bottom:20px; left:20px;
      background:#fff; padding:15px; border-radius:6px;
      box-shadow:0 2px 8px var(--shadow); max-width:280px;
      font-size:14px;
    }
    #loading {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%, -50%); background:rgba(255,255,255,0.9);
      padding:20px; border-radius:6px; box-shadow:0 2px 8px var(--shadow);
      display:none; font-size:14px; text-align:center;
    }
    /* Modal */
    #modal {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center;
    }
    #modal .content {
      background:#fff; padding:20px; border-radius:6px; width:90%; max-width:400px;
      box-shadow:0 2px 8px var(--shadow);
    }
    #modal h3 { margin-bottom:12px; color: var(--primary); }
    #modal ul { margin-left:20px; margin-bottom:12px; }
    #modal button { width:auto; padding:8px 16px; }
  </style>
</head>
<body>
  <div class="container">
    <aside>
      <h1>Voltsmart Afsprakenkaart</h1>

      <h2>Datum filter</h2>
      <label for="date-filter">Kies datum</label>
      <select id="date-filter"></select>

      <h2>Afspraakduur per operator</h2>
      <div class="grid-two">
        <div>
          <label for="duration-roelof">Roelof</label>
          <select id="duration-roelof"><option>30</option><option>45</option><option selected>60</option><option>90</option></select>
        </div>
        <div>
          <label for="duration-jesse">Jesse</label>
          <select id="duration-jesse"><option>30</option><option>45</option><option selected>60</option><option>90</option></select>
        </div>
        <div>
          <label for="duration-chanice">Chanice</label>
          <select id="duration-chanice"><option>30</option><option>45</option><option selected>60</option><option>90</option></select>
        </div>
        <div>
          <label for="duration-karlijn">Karlijn</label>
          <select id="duration-karlijn"><option>30</option><option>45</option><option selected>60</option><option>90</option></select>
        </div>
        <div>
          <label for="duration-keith">Keith</label>
          <select id="duration-keith"><option>30</option><option>45</option><option selected>60</option><option>90</option></select>
        </div>
        <div>
          <label for="duration-gio">Gio</label>
          <select id="duration-gio"><option>30</option><option>45</option><option selected>60</option><option>90</option></select>
        </div>
      </div>

      <h2>Beschikbaarheid</h2>
      <div id="availability"></div>

      <button onclick="resetSelection()">Reset selectie</button>
      <button onclick="planRoute()">Bereken route & advies</button>
    </aside>

    <main>
      <div id="map"></div>
      <div id="adviceBox">
        <strong>Klik minimaal twee afspraken...</strong>
      </div>
      <div id="loading">Afspraken laden…</div>
    </main>
  </div>

  <!-- Modal voor verplaatsadvies -->
  <div id="modal">
    <div class="content">
      <h3>Verplaatsadvies</h3>
      <ul id="modal-list"></ul>
      <button onclick="document.getElementById('modal').style.display='none'">Sluiten</button>
    </div>
  </div>

  <!-- Jouw logica vóór Maps API -->
  <script>
    window.initMap = initMap;

    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQu2tdR_UHXSEhvRq0Sga15iSOq9A6dDFfGrgLmtQ5k4oJW1NsBNb604HSecpGI9gqY5AWXjTvzArJQ/pub?output=csv";
    const OPERATOR_EMOJI = { Roelof:"👨‍🌾", Jesse:"🚀", Chanice:"✨", Karlijn:"🌸", Keith:"🟡", Gio:"👑" };
    const OPERATOR_HOME_ADDRESS = {
      Roelof:"Hemelrijk 9, Puiflijk",
      Chanice:"Harddraverstraat 32A, 3033 XL Rotterdam",
      Gio:"Savelsbos 304, 2716 HR Zoetermeer",
      Karlijn:"Spitael 92, 9202 HG Drachten",
      Jesse:"Kalf 406, 1509 BE Zaandam",
      Keith:"Jouw Straatnaam 123, 1234 AB JouwPlaats"
    };
    const KM_COST = 0.21, TIME_COST = 35;

    let map, directionsService, directionsRenderer;
    let appointments = [], markers = [], selectedMarkers = [], filteredAppointments = [];
    let medewerkerBeschikbaar = {}, geocodedHomes = {};

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), { center:{lat:52.1,lng:5.1}, zoom:7 });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers:true });
      Object.keys(OPERATOR_HOME_ADDRESS).forEach(n=>medewerkerBeschikbaar[n]=true);
      fetchAppointments();
      renderBeschikbaarheidsCheckboxen();
    }

    function fetchAppointments() {
      document.getElementById("loading").style.display = "block";
      fetch(SHEET_URL)
        .then(r => r.text())
        .then(csv => {
          const rows = csv.trim().split(/\r?\n/).slice(1);
          appointments = rows.map(row => {
            const cols = row.split(",");
            const lon = parseFloat(cols.pop());
            const lat = parseFloat(cols.pop());
            const [datum, medewerker, klant, adres, status, tijd] = cols;
            return { datum, medewerker, klant, adres, status, tijd, lat, lon };
          }).filter(a => !isNaN(a.lat) && !isNaN(a.lon));
          console.log("Gelezen afspraken:", appointments.length);
          document.getElementById("loading").style.display = "none";
          fillDateFilter();
          showMarkersForDate(getSelectedDate());
        })
        .catch(err => {
          console.error("CSV laden mislukt:", err);
          document.getElementById("loading").textContent = "Fout laden afspraken";
        });
    }

    function fillDateFilter() {
      const sel = document.getElementById("date-filter");
      const dates = [...new Set(appointments.map(a=>a.datum))]
        .sort((a,b)=>new Date(a)-new Date(b));
      sel.innerHTML = dates.map(d=>`<option>${d}</option>`).join("");
      sel.value = dates.find(d=>d>=new Date().toISOString().slice(0,10))||dates[0]||"";
      sel.onchange = ()=>showMarkersForDate(sel.value);
    }
    function getSelectedDate(){ return document.getElementById("date-filter").value; }

    function showMarkersForDate(date) {
      markers.forEach(m=>m.setMap(null));
      markers=[]; selectedMarkers=[];
      filteredAppointments = appointments.filter(a=>a.datum===date);

      if(!filteredAppointments.length){
        document.getElementById("adviceBox").innerHTML = "<strong>Geen afspraken op deze datum.</strong>";
        return;
      }

      filteredAppointments.forEach(a=>{
        const m = new google.maps.Marker({
          position:{lat:a.lat,lng:a.lon}, map,
          title:`${a.medewerker} – ${a.klant} (${a.tijd})`,
          label:{text:OPERATOR_EMOJI[a.medewerker],fontSize:"20px"}
        });
        m.metadata = a;
        m.addListener("click",()=>toggleSelect(m));
        markers.push(m);
      });

      const bounds = new google.maps.LatLngBounds();
      markers.forEach(m=>bounds.extend(m.getPosition()));
      map.fitBounds(bounds);

      document.getElementById("adviceBox").innerHTML = "<strong>Klik minimaal twee afspraken...</strong>";
    }

    function toggleSelect(m){
      if(selectedMarkers.includes(m)){
        m.setAnimation(null);
        selectedMarkers = selectedMarkers.filter(x=>x!==m);
      } else {
        m.setAnimation(google.maps.Animation.BOUNCE);
        selectedMarkers.push(m);
      }
    }

    function resetSelection(){
      selectedMarkers.forEach(m=>m.setAnimation(null));
      selectedMarkers=[];
      directionsRenderer.setDirections({routes:[]});
      document.getElementById("adviceBox").innerHTML = "<strong>Klik minimaal twee afspraken...</strong>";
    }

    function renderBeschikbaarheidsCheckboxen(){
      const div = document.getElementById("availability");
      div.innerHTML="";
      Object.keys(OPERATOR_HOME_ADDRESS).forEach(n=>{
        div.innerHTML+=
          `<div class="checkbox-row">
             <input type="checkbox" id="chk_${n}" checked onchange="toggleBeschikbaarheid('${n}')">
             <label for="chk_${n}">${n} (${OPERATOR_EMOJI[n]})</label>
           </div>`;
      });
    }
    function toggleBeschikbaarheid(n){
      medewerkerBeschikbaar[n] = !medewerkerBeschikbaar[n];
    }

    function planRoute(){
      if(selectedMarkers.length<2){
        alert("Selecteer minimaal twee afspraken.");
        return;
      }
      adviseer();
    }

    async function adviseer(){
      document.getElementById("adviceBox").textContent = "Route-advies wordt berekend…";
      await geocodeHomes();

      let best={cost:Infinity}, bestRoute;
      for(let naam in OPERATOR_HOME_ADDRESS){
        if(!medewerkerBeschikbaar[naam]) continue;
        const thuis=geocodedHomes[naam];
        const stops=selectedMarkers.map(m=>({lat:m.metadata.lat,lng:m.metadata.lon}));
        const pts=[thuis,...stops];
        let res;
        try{ res=await routePromise(pts); }catch{ continue; }
        const legs=res.routes[0].legs;
        const stats=legs.reduce((acc,leg)=>({
          dist:acc.dist+leg.distance.value/1000,
          time:acc.time+leg.duration.value/60
        }),{dist:0,time:0});
        const cost=stats.dist*KM_COST + (stats.time/60)*TIME_COST;
        if(cost<best.cost){
          best={naam,emoji:OPERATOR_EMOJI[naam],stats,cost,legs,stops};
          bestRoute=res;
        }
      }

      if(!bestRoute){
        document.getElementById("adviceBox").textContent="Geen medewerker beschikbaar.";
        return;
      }
      directionsRenderer.setDirections(bestRoute);

      // bereken verplaatsadvies
      const suggestions=[];
      for(let i=1;i<best.legs.length;i++){
        const prev=best.legs[i-1], cur=best.legs[i];
        const prevMeta=selectedMarkers[i-1].metadata, curMeta=selectedMarkers[i].metadata;
        const toMinutes=t=>{const [h,m]=t.split(":");return+h*60+ +m;};
        const slot=toMinutes(curMeta.tijd)-toMinutes(prevMeta.tijd);
        const travel=Math.round(cur.duration.value/60);
        const diff=slot-travel;
        if(diff<0) suggestions.push(`${curMeta.klant}: plan ${Math.abs(diff)} min eerder`);
        else if(diff>0) suggestions.push(`${curMeta.klant}: plan ${diff} min later`);
        else suggestions.push(`${curMeta.klant}: tijd is oké`);
      }
      // toon modal
      const ul=document.getElementById("modal-list");
      ul.innerHTML = suggestions.map(s=>`<li>${s}</li>`).join("");
      document.getElementById("modal").style.display = "flex";

      // update adviesBox
      document.getElementById("adviceBox").innerHTML =
        `<strong>Medewerker: ${best.emoji} ${best.naam}</strong>
         <ul>
           <li>Stops: ${selectedMarkers.length}</li>
           <li>Afstand: ${best.stats.dist.toFixed(1)} km</li>
           <li>Tijd: ${Math.round(best.stats.time)} min</li>
           <li>Kosten: €${Math.round(best.cost)}</li>
         </ul>`;
    }

    function routePromise(pts){
      return new Promise((resolve,reject)=>{
        directionsService.route({
          origin:pts[0], destination:pts[pts.length-1],
          waypoints:pts.slice(1,-1).map(p=>({location:p,stopover:true})),
          travelMode:"DRIVING", optimizeWaypoints:true,
          drivingOptions:{departureTime:new Date(),trafficModel:"bestguess"}
        },(r,s)=>s==="OK"?resolve(r):reject(s));
      });
    }

    async function geocodeHomes(){
      const geocoder=new google.maps.Geocoder();
      for(let n in OPERATOR_HOME_ADDRESS){
        if(!geocodedHomes[n]){
          geocodedHomes[n]=await new Promise(r=>{
            geocoder.geocode({address:OPERATOR_HOME_ADDRESS[n]},(res,st)=>{
              if(st==="OK"){const loc=res[0].geometry.location; r({lat:loc.lat(),lng:loc.lng()});}
              else r({lat:52.1,lng:5.1});
            });
          });
        }
      }
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTvDRPKBT7KDONeDgekEXlN1_CMZUtX4U&callback=initMap">
  </script>
</body>
</html>
