<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voltsmart Afsprakenkaart - Automatisch Advies</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: #0a1a2f; color: #fff; }
    #sidebar { position: absolute; top: 0; left: 0; width: 360px; height: 100%; background: rgba(10,20,40,0.95); overflow-y: auto; padding: 20px; box-sizing: border-box; }
    #map { position: absolute; top: 0; left: 360px; right: 0; bottom: 0; }
    h2 { color: #ffd700; margin-top: 20px; font-size: 20px; text-transform: uppercase; letter-spacing: 1px; }
    select, button { width: 100%; padding: 10px; margin-top: 8px; border: none; border-radius: 6px; font-size: 14px; }
    select { background: #1b2e4a; color: #fff; }
    button { background: #ffd700; color: #0a1a2f; font-weight: bold; transition: background 0.3s; }
    button:hover { background: #e6c300; }
    .legend-row, .duration-row, .appointment-item { display: flex; align-items: center; margin-top: 10px; }
    .legend-row input { transform: scale(1.2); margin-right: 10px; }
    .legend-row label, .duration-row label { flex: 1; font-size: 14px; }
    .duration-row select { width: 70px; margin-left: 10px; }
    #appointments-list { margin-top: 12px; max-height: 300px; overflow-y: auto; }
    .appointment-item { background: rgba(255,255,255,0.05); border-radius: 4px; padding: 6px; margin-bottom: 6px; }
    .appointment-item input { margin-right: 12px; transform: scale(1.1); }
    .appointment-item label { font-size: 14px; }
    #adviceBox { position: absolute; bottom: 20px; right: 20px; width: 360px; max-height: 40%; overflow-y: auto; background: rgba(0,0,0,0.85); padding: 20px; border-radius: 10px; font-size: 14px; box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Datum</h2>
    <select id="date-filter"></select>

    <h2>Operators & Duur</h2>
    <div id="legend"></div>
    <div id="durations"></div>

    <h2>Afspraken</h2>
    <div id="appointments-list"></div>

    <button id="reset-btn">ðŸ”„ Reset selectie</button>
    <button id="advise-btn">ðŸš— Bereken Advies</button>
  </div>

  <div id="map"></div>
  <div id="adviceBox"><strong>Kies datum en klik 'Bereken Advies'.</strong></div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const API_KEY = 'AIzaSyDTvDRPKBT7KDONeDgekEXlN1_CMZUtX4U';
      const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQu2tdR_UHXSEhvRq0Sga15iSOq9A6dDFfGrgLmtQ5k4oJW1NsBNb604HSecpGI9gqY5AWXjTvzArJQ/pub?output=csv';
      const EMP = { Roelof:'ðŸ‘¨â€ðŸŒ¾', Jesse:'ðŸš€', Chanice:'âœ¨', Karlijn:'ðŸŒ¸', Keith:'ðŸŸ¡', Gio:'ðŸ‘‘' };
      const TEAMS = Object.keys(EMP);
      const BUFFER = 15;
      const ORIGIN = { lat:52.1326, lng:5.2913 }, ZOOM=7;

      let map, ds;
      let apps=[], markers=[], sel=[];
      let avail={}, times={}, dates=[];

      // Load Maps API
      const s=document.createElement('script'); s.src=`https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap`; s.async=true; document.head.append(s);

      window.initMap = () => {
        map=new google.maps.Map(document.getElementById('map'),{center:ORIGIN,zoom:ZOOM});
        ds=new google.maps.DirectionsService();
        buildUI(); fetchApps();
      };

      function buildUI(){
        const lg=document.getElementById('legend'), dr=document.getElementById('durations'); lg.innerHTML=''; dr.innerHTML='';
        TEAMS.forEach(t=>{ avail[t]=true; times[t]=60;
          const lr=document.createElement('div'); lr.className='legend-row';
          const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=true; cb.onchange=()=>avail[t]=cb.checked;
          const lbl=document.createElement('label'); lbl.textContent=EMP[t]+' '+t;
          lr.append(cb,lbl); lg.append(lr);

          const drw=document.createElement('div'); drw.className='duration-row';
          const lt=document.createElement('label'); lt.textContent=t+' duur';
          const sel=document.createElement('select'); [60,90].forEach(v=>sel.append(new Option(v+'m',v)));
          sel.value=60; sel.onchange=()=>times[t]=+sel.value;
          drw.append(lt,sel); dr.append(drw);
        });
        document.getElementById('reset-btn').onclick=reset;
        document.getElementById('advise-btn').onclick=advise;
      }

      async function fetchApps(){
        const txt=await fetch(SHEET_URL).then(r=>r.text());
        apps=txt.split('\n').slice(1).map((r,i)=>{const c=r.split(',');const d=c[0],o=c[1],cl=c[2],ti=c[5];const la=parseFloat(c[8]),ln=parseFloat(c[9]);return la&&ln?{id:i,date:d,op:o,client:cl,time:ti,loc:{lat:la,lng:ln}}:null;}).filter(x=>x);
        dates=[...new Set(apps.map(a=>a.date))].sort();
        const df=document.getElementById('date-filter'); df.innerHTML='';
        dates.forEach(d=>df.append(new Option(d,d))); df.onchange=()=>display(df.value);
        display(dates[0]);
      }

      function display(date){clearMap();
        const lst=document.getElementById('appointments-list'); lst.innerHTML='';
        apps.filter(a=>a.date===date).sort((a,b)=>a.time.localeCompare(b.time)).forEach(a=>{
          const di=document.createElement('div'); di.className='appointment-item';
          const cb=document.createElement('input'); cb.type='checkbox'; cb.onchange=()=>toggle(a.id);
          const lb=document.createElement('label'); lb.textContent=`${a.time} ${EMP[a.op]} ${a.op} - ${a.client}`;
          di.append(cb,lb); lst.append(di);
          const mk=new google.maps.Marker({position:a.loc,map,label:{text:EMP[a.op],fontSize:'20px'}}); mk.meta=a; mk.addListener('click',()=>toggle(a.id)); markers.push(mk);
        }); fit(); }
      function clearMap(){markers.forEach(m=>m.setMap(null));markers=[];sel=[]; document.getElementById('appointments-list').innerHTML='';}
      function toggle(id){const m=markers.find(x=>x.meta.id===id);if(!m)return;const i=sel.indexOf(m);i>-1? (m.setIcon(),sel.splice(i,1)):(m.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png'),sel.push(m));}
      function fit(){if(markers.length){const b=new google.maps.LatLngBounds();markers.forEach(m=>b.extend(m.getPosition()));map.fitBounds(b);}else map.setCenter(ORIGIN),map.setZoom(ZOOM);}      
      function reset(){sel.forEach(m=>m.setIcon());sel=[];document.querySelectorAll('#appointments-list input').forEach(cb=>cb.checked=false);fit();}
      async function advise(){if(!sel.length)return;const date=document.getElementById('date-filter').value;const base=apps.filter(a=>a.date===date);const ops=TEAMS.filter(t=>avail[t]);const asg={};ops.forEach(t=>asg[t]=[]);base.forEach((a,i)=>asg[ops[i%ops.length]].push(a));let h='<b>Advies:</b><ul>';for(const t of ops){const ls=asg[t];if(!ls.length)continue;ls.sort((a,b)=>a.time.localeCompare(b.time));let cur=new Date(`${date}T${ls[0].time}:00`);cur.setMinutes(cur.getMinutes()+times[t]);const cf=[];for(let i=1;i<ls.length;i++){const arr=await new Promise(r=>ds.route({origin:ls[i-1].loc,destination:ls[i].loc,travelMode:'DRIVING',drivingOptions:{departureTime:cur,trafficModel:'bestguess'}},res=>r(new Date(cur.getTime()+res.routes[0].legs[0].duration_in_traffic.value*1000))));const nx=new Date(`${date}T${ls[i].time}:00`);if(arr>nx)cf.push({time:ls[i].time,sugg:arr});cur=new Date(nx);cur.setMinutes(cur.getMinutes()+times[t]);}if(cf.length){h+=`<li>${EMP[t]} <strong>${t}</strong> conflicts:${cf.length}`;cf.forEach(c=>h+=`<br>â€“${c.time}â†’${c.sugg.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`);h+='</li>';}else h+=`<li>${EMP[t]} <strong>${t}</strong> ok</li>`;}h+='</ul>';document.getElementById('adviceBox').innerHTML=h;}
    });
  </script>
</body>
</html>
