<!DOCTYPE html>
<html>
<head>
  <title>Voltsmart Afsprakenkaart</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: linear-gradient(180deg, #0a1a2f, #1b2e4a); color: white; }
    #map { height: 100vh; width: 100vw; z-index: 1; position: absolute; top: 0; left: 0; }
    #sidebar {
      position: absolute; top: 0; left: 0; width: 340px; height: 100vh;
      background: rgba(10, 20, 40, 0.97); padding: 20px 18px 12px 18px;
      box-sizing: border-box; overflow-y: auto; z-index: 999;
      box-shadow: 2px 0 8px rgba(0,0,0,0.23);
    }
    #logo { text-align: center; margin-bottom: 20px; }
    #logo img { max-width: 170px; }
    h2 { font-size: 19px; margin-bottom: 10px; color: #ffd700; }
    label, select, button { display: block; width: 100%; margin-top: 10px; }
    select, button {
      padding: 6px; border-radius: 6px; border: none;
    }
    button {
      background: #ffd700; color: #0a1a2f; font-weight: bold; cursor: pointer; margin-top: 18px;
    }
    #adviceBox {
      position: absolute; bottom: 10px; right: 10px; width: 340px; max-height: 44%;
      overflow-y: auto; background: rgba(0,0,0,0.88); color: white;
      padding: 14px; border-radius: 11px; z-index: 999; font-size: 16px;
      box-shadow: 0 0 18px 0 rgba(32,34,72,0.17);
    }
    .marker-selected { filter: drop-shadow(0 0 10px #ffd700); }
    .conflict { color: #ff5252; font-weight: bold; }
    .saving { color: #4caf50; font-weight: bold; }
    .route-step { margin-bottom: 6px; }
    .flex { display: flex; align-items: center; }
    .region { font-size:13px; color: #72e1ff; margin-left: 6px;}
  </style>
</head>
<body>
  <div id="sidebar">
    <div id="logo">
      <!-- Vervang deze afbeelding eventueel door je eigen Voltsmart-logo -->
      <img src="https://via.placeholder.com/170x48.png?text=Voltsmart" alt="Voltsmart Logo">
    </div>
    <h2>Afspraken & Instellingen</h2>
    <label for="date-filter">Datum:</label>
    <select id="date-filter"></select>

    <h2>Afspraakduur per Operator</h2>
    <label>Roelof (üë®‚Äçüåæ): <select id="duration-roelof"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></label>
    <label>Jesse (üöÄ): <select id="duration-jesse"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></label>
    <label>Chanice (‚ú®): <select id="duration-chanice"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></label>
    <label>Karlijn (üå∏): <select id="duration-karlijn"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></label>
    <label>Keith (üü°): <select id="duration-keith"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></label>
    <label>Gio (üëë): <select id="duration-gio"><option>30</option><option>45</option><option selected>60</option><option>90</option></select></label>

    <button onclick="resetSelection()">üîÑ Reset selectie</button>
    <button onclick="planRoute()">üöó Bereken route & advies</button>
  </div>

  <div id="map"></div>
  <div id="adviceBox">
    <strong>Klik minimaal twee afspraken op de kaart, klik daarna op 'Bereken route & advies'.</strong>
  </div>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTvDRPKBT7KDONeDgekEXlN1_CMZUtX4U&callback=initMap" async defer></script>
<script>
/* ------------ CONFIG & HELPERS ------------ */
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQu2tdR_UHXSEhvRq0Sga15iSOq9A6dDFfGrgLmtQ5k4oJW1NsBNb604HSecpGI9gqY5AWXjTvzArJQ/pub?output=csv";
const OPERATOR_EMOJI = { Roelof: "üë®‚Äçüåæ", Jesse: "üöÄ", Chanice: "‚ú®", Karlijn: "üå∏", Keith: "üü°", Gio: "üëë" };
const OPERATOR_REGION = {
  Roelof: "Noord-Brabant",
  Chanice: "Zuid-Holland & Utrecht",
  Gio: "Zuid-Holland & Zeeland",
  Karlijn: "Groningen",
  Jesse: "Noord-Holland (flexibel)"
};
const KM_COST = 0.21, TIME_COST = 35; // ‚Ç¨ per km / per uur

let map, directionsService, directionsRenderer;
let appointments = [], markers = [], selectedMarkers = [], filteredAppointments = [];

/* ------------ INIT ------------ */
function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 52.1, lng: 5.1 }, zoom: 7,
    styles: [{ elementType: "geometry", stylers: [{ color: "#192e49" }] }]
  });
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true });
  fetchAppointments();
}

/* ------------ DATA LAAD EN MARKERS ------------ */
function fetchAppointments() {
  fetch(SHEET_URL)
    .then(r => r.text())
    .then(csv => {
      const rows = csv.split("\n").slice(1);
      appointments = [];
      rows.forEach(row => {
        const [datum, medewerker, klant, adres, status, tijd, , , lat, lon] = row.split(",");
        if (lat && lon && !isNaN(parseFloat(lat))) {
          appointments.push({ datum, medewerker, klant, adres, status, tijd, lat: parseFloat(lat), lon: parseFloat(lon) });
        }
      });
      fillDateFilter();
      showMarkersForDate(getSelectedDate());
    });
}

/* ------------ DATUMFILTER ------------ */
function fillDateFilter() {
  const sel = document.getElementById("date-filter");
  sel.innerHTML = "";
  const dates = [...new Set(appointments.map(a => a.datum))].filter(d => d).sort();
  dates.forEach(date => {
    sel.innerHTML += `<option value="${date}">${date}</option>`;
  });
  // Standaard eerstvolgende datum selecteren
  const today = new Date().toISOString().slice(0,10);
  const firstFuture = dates.find(d => d >= today) || dates[0];
  sel.value = firstFuture;
  sel.onchange = () => showMarkersForDate(sel.value);
}

function getSelectedDate() {
  return document.getElementById("date-filter").value;
}

/* ------------ MARKERS TONEN ------------ */
function showMarkersForDate(date) {
  // Clear
  markers.forEach(m => m.setMap(null));
  markers = []; selectedMarkers = [];
  filteredAppointments = appointments.filter(a => a.datum === date);
  if (!filteredAppointments.length) return;
  filteredAppointments.forEach((a, idx) => {
    const marker = new google.maps.Marker({
      position: { lat: a.lat, lng: a.lon },
      map,
      title: `${a.medewerker} ‚Äì ${a.klant} (${a.tijd})`,
      label: { text: OPERATOR_EMOJI[a.medewerker] || "üìç", fontSize: "20px" }
    });
    marker.metadata = a;
    marker.addListener("click", () => toggleSelect(marker));
    markers.push(marker);
  });
  // Zoom kaart op afspraken
  const bounds = new google.maps.LatLngBounds();
  markers.forEach(m => bounds.extend(m.getPosition()));
  map.fitBounds(bounds);
  document.getElementById("adviceBox").innerHTML = "<strong>Klik minimaal twee afspraken op de kaart, klik daarna op 'Bereken route & advies'.</strong>";
}

/* ------------ SELECTIE ------------ */
function toggleSelect(marker) {
  if (selectedMarkers.includes(marker)) {
    marker.setIcon(null);
    marker.setAnimation(null);
    marker.label = { text: OPERATOR_EMOJI[marker.metadata.medewerker] || "üìç", fontSize: "20px" };
    selectedMarkers = selectedMarkers.filter(m => m !== marker);
    marker.setZIndex(1);
  } else {
    marker.setAnimation(google.maps.Animation.BOUNCE);
    marker.label = { text: OPERATOR_EMOJI[marker.metadata.medewerker] || "üìç", fontSize: "20px" };
    selectedMarkers.push(marker);
    marker.setZIndex(999);
  }
}

/* ------------ RESET ------------ */
function resetSelection() {
  selectedMarkers.forEach(m => { m.setAnimation(null); m.setIcon(null); });
  selectedMarkers = [];
  directionsRenderer.set("directions", null);
  document.getElementById("adviceBox").innerHTML = "<strong>Klik minimaal twee afspraken op de kaart, klik daarna op 'Bereken route & advies'.</strong>";
}

/* ------------ ROUTE EN ADVIES ------------ */
function planRoute() {
  if (selectedMarkers.length < 2) {
    alert("Selecteer minimaal twee afspraken op de kaart.");
    return;
  }
  // Sorteer markers op tijd
  selectedMarkers.sort((a, b) => a.metadata.tijd.localeCompare(b.metadata.tijd));
  const waypoints = selectedMarkers.slice(1, -1).map(m => ({
    location: m.getPosition(), stopover: true
  }));
  directionsService.route({
    origin: selectedMarkers[0].getPosition(),
    destination: selectedMarkers[selectedMarkers.length - 1].getPosition(),
    waypoints,
    travelMode: google.maps.TravelMode.DRIVING,
    drivingOptions: { departureTime: new Date(), trafficModel: "bestguess" },
    optimizeWaypoints: false
  }, (result, status) => {
    if (status !== "OK" || !result.routes.length) {
      document.getElementById("adviceBox").innerHTML = "<span class='conflict'>Geen geldige route gevonden!</span>";
      return;
    }
    directionsRenderer.setDirections(result);
    checkRouteFeasibility(result);
  });
}

/* ------------ HAALBAARHEIDSCONTROLE EN ADVIES ------------ */
function checkRouteFeasibility(routeResult) {
  // Afspraakduurtijden uit dropdowns
  const durations = {
    Roelof: +document.getElementById("duration-roelof").value,
    Jesse: +document.getElementById("duration-jesse").value,
    Chanice: +document.getElementById("duration-chanice").value,
    Karlijn: +document.getElementById("duration-karlijn").value,
    Keith: +document.getElementById("duration-keith").value,
    Gio: +document.getElementById("duration-gio").value
  };
  // Details uit directions API
  const legs = routeResult.routes[0].legs;
  let adviesHTML = "<div><b>Route-advies:</b><br><ul style='padding-left: 17px;'>";
  let haalbaar = true, totalDistance = 0, totalTime = 0;
  let prevEnd = null, prevTime = null, conflictIdx = null;
  selectedMarkers.forEach(m => m.setIcon(null)); // Reset icons

  for (let i = 0; i < legs.length; i++) {
    const appt = selectedMarkers[i].metadata;
    const leg = legs[i];
    const duration = durations[appt.medewerker] || 60;
    let geplandeTijd = appt.tijd;
    let vertrekTijd = prevEnd ? prevEnd : geplandeTijd;
    let reistijdMin = Math.round(leg.duration_in_traffic.value / 60);
    let aankomstTijd = addMinutes(vertrekTijd, reistijdMin);
    let vertrekNaAfspraak = addMinutes(aankomstTijd, duration);
    prevEnd = vertrekNaAfspraak;
    totalDistance += leg.distance.value / 1000;
    totalTime += reistijdMin + duration;

    adviesHTML += `<li class='route-step'>${OPERATOR_EMOJI[appt.medewerker] || "üìç"} <b>${appt.klant}</b>
    <span class="region">${OPERATOR_REGION[appt.medewerker] || ""}</span>
    <br>
    Gepland: <b>${geplandeTijd}</b>, Verwacht: <b>${aankomstTijd}</b> <br>
    Reistijd: ${reistijdMin} min, Afspraakduur: ${duration} min`;

    // Controleer haalbaarheid
    if (toMinutes(aankomstTijd) > toMinutes(geplandeTijd) + 5) {
      haalbaar = false; conflictIdx = i;
      selectedMarkers[i].setIcon({
        url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
      });
      adviesHTML += `<br><span class='conflict'>Te laat! Advies: verzet deze afspraak naar ${aankomstTijd}</span>`;
      break; // Stop bij eerste conflict
    }
    adviesHTML += "</li>";
  }
  adviesHTML += "</ul>";

  // Kostenbesparing (voorbeeld, kan uitgebreider)
  const besparing = Math.round((totalDistance * KM_COST) + (totalTime/60 * TIME_COST));
  adviesHTML += `<div class="saving">Totale afstand: ${totalDistance.toFixed(1)} km | Reistijd + afspraken: ${totalTime} min<br>
  Indicatieve kosten: ‚Ç¨${besparing}</div>`;

  if (!haalbaar) {
    adviesHTML += `<div class='conflict'><b>Let op:</b> Route niet haalbaar, zie rode marker(s)!</div>`;
  } else {
    adviesHTML += `<div class='saving'><b>Route is haalbaar en optimaal!</b></div>`;
  }
  adviesHTML += "</div>";
  document.getElementById("adviceBox").innerHTML = adviesHTML;
}

/* ------------ TIME HELPERS ------------ */
function toMinutes(timeStr) {
  if (!timeStr) return 0;
  const [h, m] = timeStr.split(":").map(Number);
  return h * 60 + m;
}
function addMinutes(timeStr, mins) {
  if (!timeStr) return "";
  let [h, m] = timeStr.split(":").map(Number);
  m += mins;
  h += Math.floor(m/60); m = m % 60;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
}
</script>
</body>
</html>
